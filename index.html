<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Kartonowy Nape≈Çniacz ‚Äî v0.007r</title>
  <link rel="icon" href="favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --bg:#0e1117; --panel:#121826; --panel2:#0f1624; --text:#e5e7eb; --muted:#93a4b5; --accent:#22c55e; --line:#1f2937; --yellow:#fde047; }
    body[data-theme="light"] { --bg:#f3f4f6; --panel:#ffffff; --panel2:#f9fafb; --text:#111827; --muted:#6b7280; --accent:#16a34a; --line:#e5e7eb; }
    body[data-theme="light"] .btn{background:#e5e7eb;border-color:#d1d5db}
    body[data-theme="light"] .btn.primary{background:#16a34a;border-color:#15803d;color:white}
    body[data-theme="light"] .badge{background:#e5e7eb;color:#374151;border-color:#d1d5db}
    body[data-theme="light"] .progress, body[data-theme="light"] .pr-bar{background:#e5e7eb}
    body[data-theme="light"] .pr-head select.pr-select{background:var(--panel);border-color:var(--line);color:var(--text)}
    body[data-theme="light"] .pr-reset{background:var(--panel)}
    body[data-theme="light"] .stamp .chip{background:#e5e7eb;color:#374151;border-color:#d1d5db}
    body[data-theme="light"] .notes-list .row{border-bottom-color:#e5e7eb}
    body[data-theme="light"] .tag.draft{color:#92400e;border-color:#f59e0b;background:#fef3c7}
    body[data-theme="light"] .alert{background:#e5e7eb;color:#374151;border-color:#d1d5db}
    body[data-theme="blue"] { --bg:#0c1424; --panel:#101c36; --panel2:#0e1a31; --text:#e0e7ff; --muted:#a0b3d9; --accent:#60a5fa; --line:#1e294b; }
    body[data-theme="green"] { --bg:#052e16; --panel:#064e3b; --panel2:#043a2c; --text:#ecfdf5; --muted:#a7f3d0; --accent:#4ade80; --line:#022c22; }
    body{margin:0;background:linear-gradient(180deg,var(--panel),var(--panel2));color:var(--text);font:17px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif; transition: background .3s, color .3s;}
    .wrap{max-width:1200px;margin:auto;padding:12px 16px}
    .panel{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
    .head{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--line)}
    .body{padding:10px 14px}
    .badge{font-size:12px;color:#cbd5e1;background:#0b1220;padding:4px 8px;border-radius:999px;border:1px solid var(--line)}
    .btn{border:1px solid var(--line);background:#0b1220;color:var(--text);padding:6px 10px;border-radius:10px;cursor:pointer}
    .btn.primary{background:#0d3b2c;border-color:#184c39}
    .btn.ghost{background:transparent}
    .machines{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){.machines{grid-template-columns:1fr 1fr}}
    .machine .title{display:flex;align-items:center;gap:10px}
    .machine .title h2{margin:0;font-size:26px;letter-spacing:.3px}
    .meta{color:var(--muted);font-size:12px;margin:6px 0}
    .progress{margin-top:6px;height:18px;border:1px solid var(--line);border-radius:12px;background:#0b1220;position:relative;overflow:hidden}
    .progress .bar{position:absolute;inset:0 100% 0 0;background:linear-gradient(90deg,#22c55e,#86efac);transition:width .25s ease}
    .progress .label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:12px}
    /* Pr√ºfung bigger + themed select with yellow text */
    .pruef{margin-top:10px}
    .pr-head{display:flex;gap:8px;align-items:center;margin-bottom:6px}
    .pr-head select.pr-select{background:var(--panel2);border:1px solid var(--line);color:var(--yellow);padding:8px 10px;border-radius:10px}
    .pr-bar{position:relative;height:68px;border:1px solid var(--line);border-radius:14px;background:#0b1220;overflow:hidden}
    .pr-fill{position:absolute;left:0;top:0;bottom:0;width:0%;background:linear-gradient(90deg,#22c55e,#84cc16);transition:width .5s linear}
    .pr-label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:700;letter-spacing:.3px}
    .pr-reset{position:absolute;right:10px;top:50%;transform:translateY(-50%);border:1px solid var(--line);background:var(--panel2);border-radius:8px;padding:4px 8px;cursor:pointer}
    /* Notes & Plans */
    .notes-list .row{display:flex;gap:10px;align-items:flex-start;border-bottom:1px dashed #263446;padding:8px 0}
    .stamp{display:inline-flex;gap:6px;align-items:center}
    .stamp .chip{background:#0b1220;border:1px solid #263446;border-radius:999px;padding:2px 6px}
    .stamp .small{font-size:12px;color:#9aa8b6}
    .stamp .digits{font-variant-numeric:tabular-nums;letter-spacing:.2px}
    .notes-list .txt{flex:1}
    .notes-list .act{display:flex;gap:6px}
    .tag{display:inline-block;margin-left:6px;font-size:12px;padding:2px 6px;border-radius:999px;border:1px solid #3b4760}
    .tag.draft{color:#eab308;border-color:#a16207;background:#2a2208}
    .role-badge{font-size:12px;padding:3px 8px;border-radius:999px;font-weight:600;border:1px solid transparent}
    .role-senior-dev{color:white;background-color:#3b82f6}
    .role-teamleiter{color:white;background-color:#ec4899}
    .role-einrichter{color:white;background-color:#f97316}
    .role-admin{color:white;background-color:#60a5fa}
    .role-leiharbeiter{color:white;background-color:#9ca3af}
    .role-sanner-mitarbeiter{color:white;background-color:#22c55e}
    .role-user{color:white;background-color:#9ca3af}
    .user-info-popup{position:absolute;top:100%;left:0;z-index:10;width:280px;padding-top:8px;display:none;}
    .loginbar:hover .user-info-popup{display:block;}
    .user-info-popup .panel{border-width:2px;}
    .user-info-popup-grid{display:grid;grid-template-columns:100px 1fr;gap:12px;align-items:center;}
    .user-info-popup img{width:100px;height:100px;border-radius:12px;object-fit:cover;}
    #urgent-notifications .alert{color:white; border-color:transparent;}
    /* Chat stream */
    .alerts{display:flex;flex-wrap:wrap;gap:8px}
    .alert{display:flex;gap:8px;align-items:center;border:1px solid #2e3b53;border-radius:10px;padding:6px 10px;background:#0b1220}
  </style>
</head>
<body>
  <div id="urgent-notifications" class="fixed top-0 left-1/2 -translate-x-1/2 z-30 p-4 space-y-2 w-full max-w-2xl"></div>
  <header class="wrap">
    <div class="panel">
      <div class="head">
        <div class="flex items-center gap-4">
          <img src="https://www.sanner-group.com/typo3conf/ext/sanner_site/Resources/Public/Icons/Sanner-Icons/Sanner-Logo-Claim.svg" alt="Sanner Logo" class="h-10">
          <div class="loginbar flex items-center gap-3 relative">
            <img id="userAvatar" src="https://placehold.co/40" alt="Avatar" class="w-8 h-8 rounded-full cursor-pointer">
            <div class="flex flex-col items-start">
              <div>
                <strong id="loginName">Kamil Kowalczyk</strong>
                <small id="loginId" class="opacity-70">(SoG1917)</small>
              </div>
              <span id="loginRole" class="role-badge" style="display: none;"></span>
            </div>
            <select id="loginSelect" class="btn"></select>

            <div class="user-info-popup">
              <div class="panel">
                <div class="body user-info-popup-grid">
                  <img id="popupUserAvatar" src="https://placehold.co/184" alt="User Avatar">
                  <div>
                    <h3 id="popupUserName" class="font-bold text-lg">Imiƒô Nazwisko</h3>
                    <p id="popupUserRole" class="text-sm"></p>
                    <p class="text-xs mt-2">Ostatnio zalogowany: <span id="popupLastLogin">teraz</span></p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="flex items-center gap-4">
            <div id="langSwitcher" class="flex gap-1">
              <button class="btn ghost text-xs" data-lang="pl">PL</button>
              <button class="btn ghost text-xs" data-lang="en">EN</button>
              <button class="btn ghost text-xs" data-lang="tr">TR</button>
              <button class="btn ghost text-xs" data-lang="de">DE</button>
              <button class="btn ghost text-xs" data-lang="ar">AR</button>
            </div>
            <div id="themeSwitcher" class="flex items-center gap-2">
              <button class="w-4 h-4 rounded-full border-2 border-white/20" style="background-color: #0e1117" data-theme="dark" title="Dark Theme"></button>
              <button class="w-4 h-4 rounded-full border-2 border-black/20" style="background-color: #f3f4f6" data-theme="light" title="Light Theme"></button>
              <button class="w-4 h-4 rounded-full border-2 border-white/20" style="background-color: #0c1424" data-theme="blue" title="Blue Theme"></button>
              <button class="w-4 h-4 rounded-full border-2 border-white/20" style="background-color: #052e16" data-theme="green" title="Green Theme"></button>
            </div>
            <div class="badge">v0.007r</div>
        </div>
      </div>
      <div class="body">
        <h1 class="m-0" data-translate-key="appTitle">üè≠ Kartonowy Nape≈Çniacz</h1>
        <div id="statusLine" class="opacity-80 mt-1" data-translate-key="statusReady"></div>
        <div id="chatStream" class="alerts mt-2"></div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section id="machines" class="machines"></section>

    <div id="userDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-40">
      <div class="panel w-full max-w-md">
        <div class="head">
          <h2 class="m-0">Uzupe≈Çnij swoje dane</h2>
        </div>
        <div class="body">
          <form id="userDetailsForm" class="flex flex-col gap-4">
            <p>To jest Twoje pierwsze logowanie. Prosimy o uzupe≈Çnienie danych. Pola sƒÖ opcjonalne.</p>
            <input type="text" id="detailsName" name="name" class="btn" placeholder="Imiƒô i nazwisko">
            <input type="text" id="detailsDob" name="dob" class="btn" placeholder="Data urodzenia (DD.MM.RRRR)">
            <select id="detailsLang" name="lang" class="btn">
              <option value="pl">Polski</option>
              <option value="en">English</option>
              <option value="tr">T√ºrk√ße</option>
              <option value="de">Deutsch</option>
              <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
            </select>
            <button type="submit" class="btn primary">Zapisz i kontynuuj</button>
          </form>
        </div>
      </div>
    </div>

    <div id="newUserModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4">
      <div class="panel w-full max-w-md">
        <div class="head">
          <h2 class="m-0" data-translate-key="createUserTitle">Tworzenie nowego u≈ºytkownika</h2>
          <button id="closeModalBtn" class="btn ghost">‚úñ</button>
        </div>
        <div class="body">
          <form id="newUserForm" class="flex flex-col gap-4">
            <input type="text" id="newLogin" name="login" class="btn" data-translate-key="placeholderLogin" placeholder="Login (np. SoGxxxx lub LK12)" required pattern="^(SoG[0-9]{4}|LK[0-9]{2})$">
            <input type="password" id="newPassword" name="password" class="btn" data-translate-key="placeholderPassword" placeholder="Has≈Ço" required>
            <input type="text" id="newName" name="name" class="btn" data-translate-key="placeholderName" placeholder="Imiƒô i nazwisko" required>
            <button type="submit" class="btn primary" data-translate-key="createUserBtn">Stw√≥rz u≈ºytkownika</button>
          </form>
        </div>
      </div>
    </div>

    <section class="panel mt-3">
      <div class="head"><h2 class="m-0" data-translate-key="notesTitle">üí¨ CHAT</h2></div>
      <div class="body">
        <div class="flex gap-2 flex-wrap">
          <input id="noteInput" class="btn" style="flex:1" data-translate-key="placeholderNote" placeholder="Wpisz wiadomo≈õƒá...">
          <button id="addNote" class="btn primary" data-translate-key="addNoteBtn">Wy≈õlij</button>
        </div>
        <div id="notesList" class="notes-list mt-2"></div>
      </div>
    </section>

    <section class="panel mt-3">
      <div class="head"><h2 class="m-0" data-translate-key="plansTitle">üìå Dalsze plany</h2></div>
      <div class="body">
        <div class="flex gap-2 flex-wrap">
          <input id="planInput" class="btn" style="flex:1" data-translate-key="placeholderPlan" placeholder="Nowy pomys≈Ç / zadanie‚Ä¶">
          <button id="addPlan" class="btn" data-translate-key="addPlanBtn">+ Dodaj plan</button>
          <button id="refreshNP" class="btn ghost" data-translate-key="refreshBtn">‚Üª Od≈õwie≈º z MySQL</button>
        </div>
        <div id="plansList" class="notes-list mt-2"></div>
      </div>
    </section>
  </main>

  <div id="colorPicker" class="hidden absolute panel p-2 z-20">
    <div class="grid grid-cols-4 gap-2">
      <button class="w-6 h-6 rounded-full" style="background-color: #ef4444;" data-color="#ef4444"></button>
      <button class="w-6 h-6 rounded-full" style="background-color: #f97316;" data-color="#f97316"></button>
      <button class="w-6 h-6 rounded-full" style="background-color: #eab308;" data-color="#eab308"></button>
      <button class="w-6 h-6 rounded-full" style="background-color: #84cc16;" data-color="#84cc16"></button>
      <button class="w-6 h-6 rounded-full" style="background-color: #22c55e;" data-color="#22c55e"></button>
      <button class="w-6 h-6 rounded-full" style="background-color: #14b8a6;" data-color="#14b8a6"></button>
      <button class="w-6 h-6 rounded-full" style="background-color: #3b82f6;" data-color="#3b82f6"></button>
      <button class="w-6 h-6 rounded-full" style="background-color: #a855f7;" data-color="#a855f7"></button>
      <button class="w-6 h-6 rounded-full" style="background-color: #ec4899;" data-color="#ec4899"></button>
      <button class="w-6 h-6 rounded-full bg-white border" data-color="#ffffff"></button>
      <button class="w-6 h-6 rounded-full bg-slate-400" data-color="#94a3b8"></button>
      <button class="w-6 h-6 rounded-full bg-black border" data-color="#000000"></button>
    </div>
  </div>

  <div id="customTimeModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-20">
    <div class="panel w-full max-w-xs">
      <div class="head">
        <h2 class="m-0">Ustaw czas</h2>
        <button id="closeTimeModalBtn" class="btn ghost">‚úñ</button>
      </div>
      <div class="body">
        <form id="customTimeForm" class="flex flex-col gap-4">
          <input type="number" id="customTimeInput" name="minutes" class="btn text-center text-lg" placeholder="Minuty" required>
          <button type="submit" class="btn primary">Ustaw</button>
        </form>
      </div>
    </div>
  </div>

  <footer class="wrap" id="adminFooter" style="display: none;">
    <div class="panel mt-3">
      <div class="head">
        <h2 class="m-0">üîß Panel Admina</h2>
      </div>
      <div class="body">
        <p>Tutaj znajdƒÖ siƒô opcje administracyjne, takie jak zarzƒÖdzanie u≈ºytkownikami i ich uprawnieniami.</p>
        <div id="loginHistory" class="mt-4">
            <h3 class="font-bold border-b border-white/10 pb-1">Historia logowa≈Ñ</h3>
            <div id="loginHistoryList" class="notes-list mt-2 max-h-60 overflow-y-auto"></div>
        </div>
      </div>
    </div>
  </footer>

  <template id="tpl-machine">
    <article class="panel machine">
      <div class="head">
        <div class="title"><span>ü§ñ</span><h2 class="code"></h2></div>
        <button class="btn ghost settings-toggle">‚öôÔ∏è</button>
      </div>
      <div class="body">
        <div class="meta text-sm space-y-2">
          <div class="border border-white/10 rounded-lg p-2">
            <div class="flex justify-between">
              <div class="flex gap-2">
                <span data-translate-key="auftrag">Auftrag:</span>
                <strong class="auf-val">‚Äî</strong>
              </div>
              <div class="flex gap-2">
                <span data-translate-key="nextAuftrag">Nastƒôpny Auftrag:</span>
                <span class="nextauf-val">‚Äî</span>
              </div>
            </div>
          </div>
          <div class="flex gap-2 items-center px-2">
            <span data-translate-key="model">Model:</span>
            <strong class="mdl-val">‚Äî</strong>
            <span class="w-4 h-4 rounded-full bg-white/50 border border-white/20 model-color-dot" title="Zmie≈Ñ kolor"></span>
          </div>
          <div class="border border-white/10 rounded-lg p-2">
            <span data-translate-key="period">Okres:</span>
            <span class="period-val">‚Äî</span>
          </div>
        </div>

        <div class="progress mt-3"><div class="bar"></div><div class="label">0%</div></div>

        <div class="flex justify-between items-center mt-2 text-sm">
          <div data-translate-key="timeToComplete">Do uko≈Ñczenia:</div>
          <div class="font-bold text-lg completion-time">--:--</div>
          <div class="completion-warning text-red-500 font-bold text-xl hidden">!</div>
        </div>

        <div class="pruef">
          <div class="pr-head">
            <span data-translate-key="pruefungTime">üß™ Pr√ºfung ‚Äî czas:</span>
            <div class="pr-buttons flex gap-2">
              <button class="btn ghost" data-time="3600">1H</button>
              <button class="btn ghost" data-time="7200">2H</button>
              <button class="btn ghost" data-time="10800">3H</button>
              <button class="btn ghost" data-time="custom" data-translate-key="customTime">W≈ÅASNY</button>
            </div>
          </div>
          <div class="pr-bar">
            <div class="pr-fill"></div><div class="pr-label">60:00</div><div class="pr-reset">Reset</div>
          </div>
        </div>

        <div class="machine-settings hidden mt-4 space-y-2">
          <h4 class="font-bold border-b border-white/10 pb-1">Ustawienia</h4>
          <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm items-center">
            <label>Model:</label>
            <input type="text" class="setting-input btn text-sm" data-source="order" data-key="model">
            <label>Czas (min):</label>
            <input type="number" class="setting-input btn text-sm w-24" data-source="machine" data-key="durationMin">
          </div>
           <small class="text-xs opacity-60">Wci≈õnij ENTER, aby zapisaƒá.</small>
        </div>

      </div>
    </article>
  </template>

  <script>
    // --- basic state
    const ORDERS_KEY='KN_ORDERS_V1';
    const NOTES_KEY='KN007_NOTES';
    const PLANS_KEY='KN007_PLANS';
    const ADMIN_PASS = 4753; // kod 0..1000 wymagany do publikacji SoG1917

    const TRANSLATIONS = {
      pl: {
        appTitle: 'üè≠ Kartonowy Nape≈Çniacz', createUserTitle: 'Tworzenie nowego u≈ºytkownika',
        placeholderLogin: 'Login (np. SoGxxxx lub LK12)', placeholderPassword: 'Has≈Ço', placeholderName: 'Imiƒô i nazwisko',
        createUserBtn: 'Stw√≥rz u≈ºytkownika', notesTitle: 'üí¨ CHAT', placeholderNote: 'Wpisz wiadomo≈õƒá...', addNoteBtn: 'Wy≈õlij',
        plansTitle: 'üìå Dalsze plany', placeholderPlan: 'Nowy pomys≈Ç / zadanie‚Ä¶', addPlanBtn: '+ Dodaj plan', refreshBtn: '‚Üª Od≈õwie≈º z MySQL',
        auftrag: 'Auftrag:', nextAuftrag: 'Nastƒôpny Auftrag:', model: 'Model:', period: 'Okres:', pruefungTime: 'üß™ Pr√ºfung ‚Äî czas:', customTime: 'W≈ÅASNY',
      },
      en: {
        appTitle: 'üè≠ Cardboard Filler', createUserTitle: 'Create new user',
        placeholderLogin: 'Login (e.g. SoGxxxx or LK12)', placeholderPassword: 'Password', placeholderName: 'First and last name',
        createUserBtn: 'Create User', notesTitle: 'üí¨ CHAT', placeholderNote: 'Enter a message...', addNoteBtn: 'Send',
        plansTitle: 'üìå Future plans', placeholderPlan: 'New idea / task‚Ä¶', addPlanBtn: '+ Add plan', refreshBtn: '‚Üª Refresh from MySQL',
        auftrag: 'Order:', nextAuftrag: 'Next Order:', model: 'Model:', period: 'Period:', pruefungTime: 'üß™ Pr√ºfung ‚Äî time:', customTime: 'CUSTOM',
      },
      de: {
        appTitle: 'üè≠ Karton-F√ºller', createUserTitle: 'Neuen Benutzer erstellen',
        placeholderLogin: 'Login (z.B. SoGxxxx oder LK12)', placeholderPassword: 'Passwort', placeholderName: 'Vor- und Nachname',
        createUserBtn: 'Benutzer erstellen', notesTitle: 'üí¨ CHAT', placeholderNote: 'Nachricht eingeben‚Ä¶', addNoteBtn: 'Senden',
        plansTitle: 'üìå Weitere Pl√§ne', placeholderPlan: 'Neue Idee / Aufgabe‚Ä¶', addPlanBtn: '+ Plan hinzuf√ºgen', refreshBtn: '‚Üª Von MySQL aktualisieren',
        auftrag: 'Auftrag:', nextAuftrag: 'N√§chster Auftrag:', model: 'Modell:', period: 'Zeitraum:', pruefungTime: 'üß™ Pr√ºfung ‚Äî Zeit:', customTime: 'EIGENE',
      },
      tr: {
        appTitle: 'üè≠ Karton Doldurucu', createUserTitle: 'Yeni kullanƒ±cƒ± olu≈ütur',
        placeholderLogin: 'Giri≈ü (√∂r. SoGxxxx veya LK12)', placeholderPassword: '≈ûifre', placeholderName: 'Ad ve soyad',
        createUserBtn: 'Kullanƒ±cƒ± Olu≈ütur', notesTitle: 'üí¨ SOHBET', placeholderNote: 'Bir mesaj girin...', addNoteBtn: 'G√∂nder',
        plansTitle: 'üìå Gelecek planlarƒ±', placeholderPlan: 'Yeni fikir / g√∂rev‚Ä¶', addPlanBtn: '+ Plan ekle', refreshBtn: '‚Üª MySQL\'den yenile',
        auftrag: 'Sipari≈ü:', nextAuftrag: 'Sonraki Sipari≈ü:', model: 'Model:', period: 'D√∂nem:', pruefungTime: 'üß™ Test ‚Äî s√ºre:', customTime: '√ñZEL',
      },
      ar: {
        appTitle: 'üè≠ ÿ≠ÿ¥Ÿà ÿßŸÑŸÉÿ±ÿ™ŸàŸÜ', createUserTitle: 'ÿ•ŸÜÿ¥ÿßÿ° ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ',
        placeholderLogin: 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ (ÿπŸÑŸâ ÿ≥ÿ®ŸäŸÑ ÿßŸÑŸÖÿ´ÿßŸÑ SoGxxxx ÿ£Ÿà LK12)', placeholderPassword: 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±', placeholderName: 'ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ£ŸàŸÑ ŸàÿßŸÑÿ£ÿÆŸäÿ±',
        createUserBtn: 'ÿ•ŸÜÿ¥ÿßÿ° ŸÖÿ≥ÿ™ÿÆÿØŸÖ', notesTitle: 'üí¨ ÿØÿ±ÿØÿ¥ÿ©', placeholderNote: 'ÿ£ÿØÿÆŸÑ ÿ±ÿ≥ÿßŸÑÿ©‚Ä¶', addNoteBtn: 'ÿ•ÿ±ÿ≥ÿßŸÑ',
        plansTitle: 'üìå ÿÆÿ∑ÿ∑ ŸÖÿ≥ÿ™ŸÇÿ®ŸÑŸäÿ©', placeholderPlan: 'ŸÅŸÉÿ±ÿ© / ŸÖŸáŸÖÿ© ÿ¨ÿØŸäÿØÿ©‚Ä¶', addPlanBtn: '+ ÿ•ÿ∂ÿßŸÅÿ© ÿÆÿ∑ÿ©', refreshBtn: '‚Üª ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÜ MySQL',
        auftrag: 'ÿ∑ŸÑÿ®:', nextAuftrag: 'ÿßŸÑÿ∑ŸÑÿ® ÿßŸÑÿ™ÿßŸÑŸä:', model: 'ŸÜŸÖŸàÿ∞ÿ¨:', period: 'ŸÅÿ™ÿ±ÿ©:', pruefungTime: 'üß™ ŸÅÿ≠ÿµ ‚Äî ÿßŸÑŸàŸÇÿ™:', customTime: 'ŸÖÿÆÿµÿµ',
      }
    };

    let USERS = {
      'SoG1917': { name: 'Kamil Kowalczyk', avatar: '', password: String(ADMIN_PASS) },
      'SoG2025': { name: 'John Locke', avatar: '' },
      'SoG1':    { name: 'Michael Scott', avatar: '' },
      'SoG1899': { name: 'James Corden', avatar: '' },
      'SoP1':    { name: 'Piotr Nowak', avatar: '' },
      'SoG2200': { name: 'User 2200', avatar: '' },
      'SoG2020': { name: 'User 2020', avatar: '' },
    };

    const DEFAULTS={
      user: { uid: 'SoG1917' },
      users: USERS,
      machines:[
        { code:'MA820061', durationMin:25, pruef:3600 },
        { code:'MA820062',  durationMin:22, pruef:3600 },
        { code:'MA820063', durationMin:25, pruef:3600 },
        { code:'MA820064', durationMin:25, pruef:3600 },
      ],
      orders:{},
    };
    let CFG=JSON.parse(localStorage.getItem('KN007_CFG')||'null')||DEFAULTS;
    // ensure USERS is up to date
    if (CFG.users) { USERS = CFG.users; } else { CFG.users = USERS; }

    const $=(s,r=document)=>r.querySelector(s), $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const isAdmin=()=> CFG.user?.uid==='SoG1917';
    function persist(){ localStorage.setItem('KN007_CFG', JSON.stringify(CFG)); }
    function setStatus(t){ $('#statusLine').textContent='Status: '+t; }

    // --- kv storage via php
    async function saveShared(key,json){ try{ const res=await fetch('storage.php?a=set&key='+encodeURIComponent(key),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(json)}); const j=await res.json(); return !!j.ok; }catch(e){ console.error(e); return false; } }
    async function loadShared(key){ try{ const res=await fetch('storage.php?a=get&key='+encodeURIComponent(key)); const j=await res.json(); return j.v?JSON.parse(j.v):null; }catch(e){ console.error(e); return null; } }

    // --- machines (minimal for 0.007 look)
    let activePruefung = null;
    class Pruefung{ constructor(root){ this.root=root; this.fill=$('.pr-fill',root); this.label=$('.pr-label',root); this.buttons=$$('.pr-buttons button',root); this.reset=$('.pr-reset',root); this.bar=$('.pr-bar', root);
        this.total=3600; this.start=Date.now(); this.bind(); this.tick(); }
      bind(){
        this.buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                this.buttons.forEach(b => b.classList.remove('primary'));
                btn.classList.add('primary');
                const v = btn.dataset.time;
                if (v === 'custom') {
                    const m = prompt('Wpisz czas w minutach:', '60');
                    this.setTime(m);
                } else {
                    this.total = parseInt(v, 10);
                    this.start = Date.now();
                }
            });
        });
        this.reset.addEventListener('click',()=>{ this.start=Date.now(); this.buttons.forEach(b => b.classList.remove('primary')); });
        this.bar.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            activePruefung = this;
            $('#customTimeModal').classList.remove('hidden');
            $('#customTimeInput').focus();
        });
      }
      setTime(minutes) {
        this.total = Math.max(60, (parseInt(minutes, 10) || 0) * 60);
        this.start = Date.now();
        this.buttons.forEach(b => b.classList.remove('primary'));
      }
      tick(){ const el=Math.min(this.total, Math.floor((Date.now()-this.start)/1000)); const left=this.total-el; const pct=this.total > 0 ? Math.floor(el/this.total*100) : 0;
        this.fill.style.width=pct+'%'; const mm=String(Math.floor(left/60)).padStart(2,'0'), ss=String(left%60).padStart(2,'0'); this.label.textContent=`${mm}:${ss}`;
        requestAnimationFrame(()=>this.tick()); }
    }

    let activeMachineForColor = null;
    class Machine{ constructor(container,data,orders){ this.root=$('#tpl-machine').content.firstElementChild.cloneNode(true);
        this.data = data;
        this.orders = orders;
        this.code=data.code; $('.code',this.root).textContent=this.code;

        if (!this.data.completionTimestamp) {
          this.data.completionTimestamp = Date.now() + (Math.floor(Math.random() * 14940) + 60) * 1000;
        }

        this.dot = $('.model-color-dot', this.root);
        this.dot.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            activeMachineForColor = this;
            const picker = $('#colorPicker');
            picker.style.left = e.pageX + 'px';
            picker.style.top = e.pageY + 'px';
            picker.classList.remove('hidden');
        });

        this.completionTimeEl = $('.completion-time', this.root);
        this.completionWarningEl = $('.completion-warning', this.root);

        this.settingsToggle = $('.settings-toggle', this.root);
        this.settingsPanel = $('.machine-settings', this.root);
        this.settingsInputs = $$('.setting-input', this.settingsPanel);

        this.settingsToggle.addEventListener('click', () => this.settingsPanel.classList.toggle('hidden'));
        this.settingsInputs.forEach(input => {
            input.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') this.saveSetting(input);
            });
        });

        this.bar=$('.bar',this.root); this.label=$('.label',this.root);
        container.appendChild(this.root); this.pr=new Pruefung($('.pruef',this.root));
        // simple progress demo
        let start=performance.now(), dur=(data.durationMin||25)*60000; const step=()=>{ const p=Math.min(1,(performance.now()-start)/dur); this.bar.style.width=(p*100)+'%'; this.label.textContent=Math.floor(p*100)+'%'; requestAnimationFrame(step) }; requestAnimationFrame(step);

        this.render();
        this.tickCompletion();
    }
      saveSetting(input) {
        const key = input.dataset.key;
        const source = input.dataset.source;
        let value = input.value;
        if(input.type === 'number') value = parseFloat(value) || 0;

        if (source === 'machine') {
            this.data[key] = value;
        } else if (source === 'order') {
            if (!this.orders[this.code]) this.orders[this.code] = genOrder();
            this.orders[this.code][key] = value;
        }

        input.blur();
        this.render();
        persist();
        setStatus('Zapisano ' + key);
      }
      render() {
        const order = this.orders[this.code] || {};
        $('.auf-val',this.root).textContent = order.auftrag || '‚Äî';
        $('.mdl-val',this.root).textContent = order.model || '‚Äî';
        $('.period-val',this.root).textContent = order.period || '‚Äî';
        $('.nextauf-val',this.root).textContent = order.next || '‚Äî';

        this.dot.style.backgroundColor = this.data.color || '#94a3b8';

        // Populate settings inputs
        this.settingsInputs.forEach(input => {
            const key = input.dataset.key;
            const source = input.dataset.source;
            if (source === 'machine') {
                input.value = this.data[key] || '';
            } else if (source === 'order') {
                input.value = order[key] || '';
            }
        });
      }
      setColor(color) {
        this.data.color = color;
        this.render();
        persist();
      }
      tickCompletion() {
        const now = Date.now();
        const timeLeft = Math.max(0, Math.floor((this.data.completionTimestamp - now) / 1000));
        const hours = Math.floor(timeLeft / 3600);
        const minutes = Math.floor((timeLeft % 3600) / 60);
        this.completionTimeEl.textContent = `${String(hours)}h ${String(minutes).padStart(2, '0')}m`;

        const twoHours = 2 * 3600; const oneHour = 1 * 3600;
        if (timeLeft > 0 && timeLeft < twoHours) {
            this.completionWarningEl.classList.remove('hidden');
            if (timeLeft < oneHour) {
                showUrgentNotification(this.code, `Koniec Auftragu ${this.code} w ciƒÖgu godziny!`, 'danger');
            } else {
                showUrgentNotification(this.code, `Koniec Auftragu ${this.code} w ciƒÖgu 2 godzin!`, 'warning');
            }
        } else {
            this.completionWarningEl.classList.add('hidden');
            hideUrgentNotification(this.code);
        }
        requestAnimationFrame(()=>this.tickCompletion());
      }
    }

    function genOrder(){ const rnd=String(Math.floor(Math.random()*10000)).padStart(4,'0'); const s=new Date(); const e=new Date(); e.setDate(s.getDate()+5);
      const F=d=>`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`;
      return { auftrag:'1012'+rnd, model:'DASG-1 (201044)', period:`od ${F(s)} do ${F(e)}`, next:'' };
    }

    function renderMachines(){ const box=$('#machines'); box.innerHTML=''; (CFG.machines||[]).forEach(m=> new Machine(box,m, CFG.orders||{})); }

    // --- stamps
    function makeStamp(ts,user,smaller=false){
      const d=new Date(ts);
      const dd=String(d.getDate()).padStart(2,'0'), mm=String(d.getMonth()+1).padStart(2,'0'), yyyy=d.getFullYear();
      const hh=String(d.getHours()).padStart(2,'0'), min=String(d.getMinutes()).padStart(2,'0');
      const small=smaller?' small':'';
      return `<span class="stamp">
        <span class="chip small digits${small}">[${dd}/${mm}/${yyyy}]</span>
        <span class="chip small digits${small}">[${hh}:${min}]</span>
        <span class="chip small">${user.uid} (${user.name})</span>
      </span>`;
    }

    // --- chat stream
    function chatPush(text){ const el=document.createElement('div'); el.className='alert'; el.innerHTML=`<span>üí¨ ${text}</span> <button class="btn ghost">‚úñ</button>`; $('.btn',el).onclick=()=>el.remove(); $('#chatStream').prepend(el); }

    // --- notes / plans
    let NOTES=[], PLANS=[];
    function renderNotes(){
      const list=$('#notesList'); list.innerHTML='';
      NOTES.forEach(n=>{
        const row=document.createElement('div'); row.className='row';
        const tag = n.status==='DRAFT' ? '<span class="tag draft">DRAFT</span>' : '';
        row.innerHTML=`<div class="meta">${makeStamp(n.ts, {uid:n.user,name:n.userName})} ${tag}</div>
                       <div class="txt">${n.text}</div>
                       <div class="act"></div>`;
        const act=$('.act',row);
        if(isAdmin()){
          const bE=document.createElement('button'); bE.className='btn'; bE.textContent='‚úèÔ∏è'; bE.title='Edytuj';
          const bR=document.createElement('button'); bR.className='btn'; bR.textContent='‚Ü©Ô∏è'; bR.title='Odpowiedz';
          const bD=document.createElement('button'); bD.className='btn'; bD.textContent='üóëÔ∏è'; bD.title='Usu≈Ñ';
          bE.onclick=async()=>{ const v=prompt('Edytuj notatkƒô', n.text); if(v!=null){ n.text=v; await saveNotes(); renderNotes(); } };
          bR.onclick=async()=>{ const v=prompt('Odpowied≈∫', ''); if(v){ NOTES.push({id:Date.now()+Math.random(), ts:Date.now(), user:CFG.user.uid, userName:CFG.user.name, text:`‚Ü™ ${v} (odpowied≈∫ na #${n.id})`, status:'FINAL'}); await saveNotes(); renderNotes(); } };
          bD.onclick=async()=>{ if(confirm('UsunƒÖƒá notatkƒô?')){ NOTES = NOTES.filter(x=>x.id!==n.id); await saveNotes(); renderNotes(); } };
          act.append(bE,bR,bD);
        }
        list.appendChild(row);
      });
    }
    function renderPlans(){
      const list=$('#plansList'); list.innerHTML='';
      PLANS.forEach(p=>{
        const row=document.createElement('div'); row.className='row';
        row.innerHTML=`<div class="meta">${makeStamp(p.ts, {uid:p.user,name:p.userName}, true)}</div>
                       <div class="txt">${p.text}</div>`;
        list.appendChild(row);
      });
    }
    async function saveNotes(){ await saveShared(NOTES_KEY, NOTES); }
    async function loadNotes(){ const db=await loadShared(NOTES_KEY); if(db){ NOTES=db; } renderNotes(); }
    async function savePlans(){ await saveShared(PLANS_KEY, PLANS); }
    async function loadPlans(){ const db=await loadShared(PLANS_KEY); if(db){ PLANS=db; } renderPlans(); }

    // --- login
    function getUserRole(uid) {
        if (!uid) return null;
        const ROLES = {
            'SoG1917': { name: 'Senior Developer', className: 'role-senior-dev' },
            'SoG2025': { name: 'TeamLeiter', className: 'role-teamleiter' },
            'SoG2200': { name: 'Einrichter', className: 'role-einrichter' },
            'SoG2020': { name: 'Einrichter', className: 'role-einrichter' },
        };
        if (ROLES[uid]) return ROLES[uid];
        if (uid.startsWith('SoG')) return { name: 'Administrator', className: 'role-admin' };
        if (uid.startsWith('LK')) return { name: 'Leiharbeiter', className: 'role-leiharbeiter' };
        if (uid.startsWith('SoP')) return { name: 'Administrator', className: 'role-admin' };
        return { name: 'U≈ºytkownik', className: 'role-user' };
    }

    function showUser(){
      const uid = CFG.user?.uid;
      const user = USERS[uid] || { name: 'Nieznany', avatar: '' };

      $('#loginName').textContent = user.name;
      $('#loginId').textContent = uid || '';
      const avatarSrc = user.avatar || 'https://placehold.co/40/0e1117/ffffff?text=' + (user.name?.[0] || '?');
      $('#userAvatar').src = avatarSrc;

      const role = getUserRole(uid);
      const roleEl = $('#loginRole');
      if (role) {
        roleEl.textContent = role.name;
        roleEl.className = 'role-badge ' + role.className;
        roleEl.style.display = 'inline-block';
      } else {
        roleEl.style.display = 'none';
      }

      // Update popup
      $('#popupUserAvatar').src = user.avatar || 'https://placehold.co/184/0e1117/ffffff?text=' + (user.name?.[0] || '?');
      $('#popupUserName').textContent = user.name;
      $('#popupUserRole').textContent = role ? role.name : 'U≈ºytkownik';
    }

    function showUserDetailsModal() {
        const currentUser = USERS[CFG.user.uid];
        if (currentUser) {
            $('#detailsName').value = currentUser.name || '';
            $('#detailsLang').value = CFG.language || 'pl';
        }
        $('#userDetailsModal').classList.remove('hidden');
    }

    function initUserDetailsModal() {
        $('#userDetailsForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const user = USERS[CFG.user.uid];
            if (user) {
                user.name = $('#detailsName').value;
                user.dob = $('#detailsDob').value;
                user.details_filled = true;

                const selectedLang = $('#detailsLang').value;
                setLanguage(selectedLang);

                CFG.users = USERS;
                persist();

                showUser();
                $('#userDetailsModal').classList.add('hidden');
                window.location.reload();
            }
        });
    }

    function initLogin(){
      const loginSelect = $('#loginSelect');

      // Populate select
      loginSelect.innerHTML = '<option value="new_user">+ Nowy u≈ºytkownik</option>';
      for (const uid in USERS) {
        const user = USERS[uid];
        const option = document.createElement('option');
        option.value = uid;
        option.textContent = `${user.name} (${uid})`;
        loginSelect.appendChild(option);
      }

      loginSelect.value = CFG.user.uid;
      showUser();

      const currentUser = USERS[CFG.user.uid];
      if (currentUser && !currentUser.details_filled) {
        showUserDetailsModal();
      }

      loginSelect.addEventListener('change', () => {
        const selectedValue = loginSelect.value;
        if (selectedValue === 'new_user') {
          $('#newUserModal').classList.remove('hidden');
          loginSelect.value = CFG.user.uid; // revert selection
          return;
        }

        const userToLogin = USERS[selectedValue];
        if (userToLogin && userToLogin.password) {
          const pass = prompt(`Wprowad≈∫ has≈Ço dla ${selectedValue}:`);
          if (pass !== userToLogin.password) {
            alert('B≈Çƒôdne has≈Ço!');
            loginSelect.value = CFG.user.uid; // revert
            return;
          }
        }

        logLogin(selectedValue);
        CFG.user.uid = selectedValue;
        persist();

        const newCurrentUser = USERS[selectedValue];
        if (newCurrentUser && !newCurrentUser.details_filled) {
            showUser();
            showUserDetailsModal();
        } else {
            window.location.reload();
        }
      });

      $('#userAvatar').addEventListener('click', () => {
        const newAvatar = prompt('Podaj nowy URL avatara:', USERS[CFG.user.uid].avatar || '');
        if (newAvatar !== null) {
          USERS[CFG.user.uid].avatar = newAvatar;
          CFG.users = USERS; // make sure the global change is stored
          persist();
          showUser();
        }
      });

      $('#closeModalBtn').onclick = () => {
        $('#newUserModal').classList.add('hidden');
      };

      $('#newUserForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const login = $('#newLogin').value;
        const password = $('#newPassword').value;
        const name = $('#newName').value;

        if (!/^(SoG[0-9]{4}|LK[0-9]{2}|[0-9]{2}|[0-9]{4})$/.test(login)) {
          alert('Format loginu jest nieprawid≈Çowy. U≈ºyj formatu SoGxxxx, LKxx, xx lub xxxx.');
          return;
        }

        if (USERS[login]) {
          alert('U≈ºytkownik o takim loginie ju≈º istnieje.');
          return;
        }

        USERS[login] = { name: name, avatar: '', password: password || undefined, details_filled: false };
        CFG.users = USERS;
        logLogin(login);
        CFG.user.uid = login;
        persist();

        $('#newUserModal').classList.add('hidden');
        $('#newUserForm').reset();
        showUser();
        showUserDetailsModal();
      });
    }

    // --- init buttons
    function initNotesPlans(){
      $('#addNote').onclick=async()=>{
        const v=$('#noteInput').value.trim(); if(!v) return;
        let status='FINAL';
        if(isAdmin()){
          const code=prompt('Podaj kod (0..1000) aby opublikowaƒá do ‚Äûchat‚Äù. B≈Çƒôdny -> DRAFT:','');
          const n = parseInt(code,10);
          if(!(n>=0 && n<=1000) || n!==ADMIN_PASS){
            status='DRAFT';
          } else {
            status='FINAL';
            chatPush(v);
          }
        }
        NOTES.push({id:Date.now()+Math.random(), ts:Date.now(), user:CFG.user.uid, userName:CFG.user.name, text:v, status});
        $('#noteInput').value=''; await saveNotes(); renderNotes();
      };
      $('#addPlan').onclick=async()=>{
        const v=$('#planInput').value.trim(); if(!v) return;
        PLANS.push({id:Date.now()+Math.random(), ts:Date.now(), user:CFG.user.uid, userName:CFG.user.name, text:v});
        $('#planInput').value=''; await savePlans(); renderPlans();
      };
      $('#refreshNP').onclick=async()=>{ await loadNotes(); await loadPlans(); };
      loadNotes(); loadPlans();
    }

    // --- machines render
    function initMachines(){ const box=$('#machines'); box.innerHTML=''; (CFG.machines||[]).forEach(m=> new Machine(box,m, CFG.orders||{})); }

    function initThemeSwitcher() {
      const themeButtons = $$('#themeSwitcher button');
      const body = document.body;

      function applyTheme(theme) {
        body.dataset.theme = theme;
        CFG.theme = theme;
        persist();
      }

      // Apply saved theme on load
      if (CFG.theme) {
        applyTheme(CFG.theme);
      }

      themeButtons.forEach(button => {
        button.addEventListener('click', () => {
          const theme = button.dataset.theme;
          applyTheme(theme);
        });
      });
    }

    function getTerminalId() {
        let terminal = localStorage.getItem('KN007_TERMINAL');
        if (!terminal) {
            const terminalName = 'Terminal' + String(Math.floor(Math.random() * 900) + 100).padStart(3, '0');
            const terminalKey = Math.random().toString(36).substring(2, 7);
            terminal = `${terminalName} (${terminalKey})`;
            localStorage.setItem('KN007_TERMINAL', terminal);
        }
        return terminal;
    }

    function logLogin(uid) {
        const user = USERS[uid];
        if (!user) return;

        const history = JSON.parse(localStorage.getItem('KN007_LOGINS') || '[]');
        const now = new Date();
        const terminalId = getTerminalId();
        const role = getUserRole(uid);

        const logEntry = {
            ts: now.toISOString(),
            user: `${uid} (${user.name || 'N/A'})`,
            terminal: terminalId,
            accountType: role ? role.name : 'U≈ºytkownik'
        };

        history.unshift(logEntry);
        if (history.length > 100) {
            history.pop();
        }
        localStorage.setItem('KN007_LOGINS', JSON.stringify(history));
    }

    function renderLoginHistory() {
        if (!isAdmin()) return;
        const list = $('#loginHistoryList');
        if (!list) return;

        const history = JSON.parse(localStorage.getItem('KN007_LOGINS') || '[]');
        if (history.length === 0) {
            list.innerHTML = '<p class="opacity-70">Brak historii logowa≈Ñ.</p>';
            return;
        }

        list.innerHTML = '';
        history.forEach(entry => {
            const d = new Date(entry.ts);
            const date = d.toLocaleDateString('pl-PL');
            const time = d.toLocaleTimeString('pl-PL');
            const logHtml = `<div class="row !items-center"><div class="txt text-sm">U≈ºytkownik <strong>${entry.user}</strong> zalogowa≈Ç siƒô dnia ${date} o godz. ${time} z <strong>${entry.terminal}</strong> na konto <strong>${entry.accountType}</strong>.</div></div>`;
            list.insertAdjacentHTML('beforeend', logHtml);
        });
    }

    function renderAdminPanel() {
      const footer = $('#adminFooter');
      if (isAdmin()) {
        footer.style.display = 'block';
        renderLoginHistory();
      } else {
        footer.style.display = 'none';
      }
    }

    function setLanguage(lang) {
        if (!TRANSLATIONS[lang]) return;
        document.documentElement.lang = lang;
        document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
        if (lang === 'ar') { document.body.style.fontSize = '17px'; }
        else { document.body.style.fontSize = '15px'; }

        $$('[data-translate-key]').forEach(el => {
            const key = el.dataset.translateKey;
            const translation = TRANSLATIONS[lang][key];
            if (translation) {
                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    el.placeholder = translation;
                } else {
                    // Sanitize to prevent HTML injection if keys are ever dynamic
                    const safeContent = document.createTextNode(translation);
                    // Handle elements with children (like the title H1)
                    const icon = el.querySelector('span');
                    el.innerHTML = ''; // Clear existing content
                    if(icon) el.appendChild(icon);
                    el.appendChild(safeContent);
                }
            }
        });
        CFG.language = lang;
        persist();

        $$('#langSwitcher button').forEach(btn => {
            btn.classList.toggle('primary', btn.dataset.lang === lang);
        });
    }

    function initLangSwitcher() {
        const langButtons = $$('#langSwitcher button');
        langButtons.forEach(button => {
            button.addEventListener('click', () => setLanguage(button.dataset.lang));
        });
        setLanguage(CFG.language || 'pl');
    }

    function initCustomTimeModal() {
        const modal = $('#customTimeModal');
        const form = $('#customTimeForm');
        const input = $('#customTimeInput');
        const closeBtn = $('#closeTimeModalBtn');

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (activePruefung) {
                activePruefung.setTime(input.value);
            }
            modal.classList.add('hidden');
            activePruefung = null;
        });
        closeBtn.onclick = () => {
            modal.classList.add('hidden');
            activePruefung = null;
        };
    }

    function initColorPicker() {
        const picker = $('#colorPicker');
        $$('button', picker).forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                const color = button.dataset.color;
                if (activeMachineForColor) {
                    activeMachineForColor.setColor(color);
                }
                picker.classList.add('hidden');
                activeMachineForColor = null;
            });
        });
        document.addEventListener('click', (e) => {
            if (!picker.contains(e.target) && activeMachineForColor) {
                picker.classList.add('hidden');
                activeMachineForColor = null;
            }
        });
    }

    const activeNotifications = {};
    function showUrgentNotification(id, message, level) {
        const container = $('#urgent-notifications');
        const existing = $(`#notification-${id}`, container);
        const newClass = level === 'danger' ? 'bg-red-800/90' : 'bg-orange-500/90';
        if (existing) {
            if (!existing.classList.contains(newClass)) {
                existing.className = `alert ${newClass} transition-all`;
                existing.innerHTML = `<strong>PILNE:</strong> ${message}`;
            }
            return;
        }
        const el = document.createElement('div');
        el.id = `notification-${id}`;
        el.className = `alert ${newClass}`;
        el.innerHTML = `<strong>PILNE:</strong> ${message}`;
        container.appendChild(el);
        activeNotifications[id] = el;
    }
    function hideUrgentNotification(id) {
        if (activeNotifications[id]) {
            activeNotifications[id].remove();
            delete activeNotifications[id];
        }
    }

    function init(){ initThemeSwitcher(); initLangSwitcher(); initMachines(); initLogin(); initNotesPlans(); initUserDetailsModal(); renderAdminPanel(); initCustomTimeModal(); }
    init();
  </script>
</body>
</html>
