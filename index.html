<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Kartonowy Napełniacz — v0.007r</title>
  <link rel="icon" href="favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --bg:#0e1117; --panel:#121826; --panel2:#0f1624; --text:#e5e7eb; --muted:#93a4b5; --accent:#22c55e; --line:#1f2937; --yellow:#fde047; }
    body[data-theme="light"] { --bg:#f3f4f6; --panel:#ffffff; --panel2:#f9fafb; --text:#111827; --muted:#6b7280; --accent:#16a34a; --line:#e5e7eb; }
    body[data-theme="light"] .btn{background:#e5e7eb;border-color:#d1d5db}
    body[data-theme="light"] .btn.primary{background:#16a34a;border-color:#15803d;color:white}
    body[data-theme="light"] .badge{background:#e5e7eb;color:#374151;border-color:#d1d5db}
    body[data-theme="light"] .progress, body[data-theme="light"] .pr-bar{background:#e5e7eb}
    body[data-theme="light"] .pr-head select.pr-select{background:var(--panel);border-color:var(--line);color:var(--text)}
    body[data-theme="light"] .pr-reset{background:var(--panel)}
    body[data-theme="light"] .stamp .chip{background:#e5e7eb;color:#374151;border-color:#d1d5db}
    body[data-theme="light"] .notes-list .row{border-bottom-color:#e5e7eb}
    body[data-theme="light"] .tag.draft{color:#92400e;border-color:#f59e0b;background:#fef3c7}
    body[data-theme="light"] .alert{background:#e5e7eb;color:#374151;border-color:#d1d5db}
    body[data-theme="blue"] { --bg:#0c1424; --panel:#101c36; --panel2:#0e1a31; --text:#e0e7ff; --muted:#a0b3d9; --accent:#60a5fa; --line:#1e294b; }
    body[data-theme="green"] { --bg:#052e16; --panel:#064e3b; --panel2:#043a2c; --text:#ecfdf5; --muted:#a7f3d0; --accent:#4ade80; --line:#022c22; }
    body{margin:0;background:linear-gradient(180deg,var(--panel),var(--panel2));color:var(--text);font:17px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif; transition: background .3s, color .3s;}
    .wrap{max-width:1200px;margin:auto;padding:12px 16px}
    .panel{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
    .head{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--line)}
    .body{padding:10px 14px}
    .badge{font-size:12px;color:#cbd5e1;background:#0b1220;padding:4px 8px;border-radius:999px;border:1px solid var(--line)}
    .btn{border:1px solid var(--line);background:#0b1220;color:var(--text);padding:6px 10px;border-radius:10px;cursor:pointer}
    .btn.primary{background:#0d3b2c;border-color:#184c39}
    .btn.ghost{background:transparent}
    .machines{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){.machines{grid-template-columns:1fr 1fr}}
    .machine .title{display:flex;align-items:center;gap:10px}
    .machine .title h2{margin:0;font-size:26px;letter-spacing:.3px}
    .meta{color:var(--muted);font-size:12px;margin:6px 0}
    .progress{margin-top:6px;height:18px;border:1px solid var(--line);border-radius:12px;background:#0b1220;position:relative;overflow:hidden}
    .progress .bar{position:absolute;inset:0 100% 0 0;background:linear-gradient(90deg,#22c55e,#86efac);transition:width .25s ease}
    .progress .label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:12px}
    /* Prüfung bigger + themed select with yellow text */
    .pruef{margin-top:10px}
    .pr-head{display:flex;gap:8px;align-items:center;margin-bottom:6px}
    .pr-head select.pr-select{background:var(--panel2);border:1px solid var(--line);color:var(--yellow);padding:8px 10px;border-radius:10px}
    body[data-theme="light"] .model-color-dot { border-color: #cbd5e1 !important; }
    .pr-bar{position:relative;height:36px;border:1px solid var(--line);border-radius:14px;background:#0b1220;overflow:hidden}
    .pr-buttons button { font-size: 0.7rem; }
    .pr-fill{position:absolute;left:0;top:0;bottom:0;width:0%;background:linear-gradient(90deg,#22c55e,#84cc16);transition:width .5s linear}
    .pr-label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:700;letter-spacing:.3px}
    .pr-reset{position:absolute;right:10px;top:50%;transform:translateY(-50%);border:1px solid var(--line);background:var(--panel2);border-radius:8px;padding:4px 8px;cursor:pointer}
    /* Notes & Plans */
    .notes-list .row{display:flex;gap:10px;align-items:flex-start;border-bottom:1px dashed #263446;padding:8px 0}
    .stamp{display:inline-flex;gap:6px;align-items:center}
    .stamp .chip{background:#0b1220;border:1px solid #263446;border-radius:999px;padding:2px 6px}
    .stamp .small{font-size:12px;color:#9aa8b6}
    .stamp .digits{font-variant-numeric:tabular-nums;letter-spacing:.2px}
    .notes-list .txt{flex:1}
    .notes-list .act{display:flex;gap:6px}
    .tag{display:inline-block;margin-left:6px;font-size:12px;padding:2px 6px;border-radius:999px;border:1px solid #3b4760}
    .tag.draft{color:#eab308;border-color:#a16207;background:#2a2208}
    .role-badge{font-size:12px;padding:3px 8px;border-radius:999px;font-weight:600;border:1px solid transparent}
    .carton-box{position:relative;border:1px solid var(--line);border-radius:8px;overflow:hidden;background:var(--panel2)}
    .carton-fill{position:absolute;bottom:0;left:0;right:0;width:100%;height:0%;background-color:var(--accent);transition:height .5s linear}
    .carton-label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700}
    .role-senior-dev{color:white;background-color:#3b82f6}
    .role-teamleiter{color:white;background-color:#ec4899}
    .role-einrichter{color:white;background-color:#f97316}
    .role-admin{color:white;background-color:#60a5fa}
    .role-leiharbeiter{color:white;background-color:#9ca3af}
    .role-sanner-mitarbeiter{color:white;background-color:#22c55e}
    .role-user{color:white;background-color:#9ca3af}
    .user-info-popup{position:absolute;top:100%;left:0;z-index:10;width:280px;padding-top:8px;display:none;}
    .loginbar:hover .user-info-popup{display:block;}
    .user-info-popup .panel{border-width:2px;}
    .user-info-popup-grid{display:grid;grid-template-columns:100px 1fr;gap:12px;align-items:center;}
    .user-info-popup img{width:100px;height:100px;border-radius:12px;object-fit:cover;}
    #urgent-notifications .alert{color:white; border-color:transparent;}
    /* Chat stream */
    .alerts{display:flex;flex-wrap:wrap;gap:8px}
    .alert{display:flex;gap:8px;align-items:center;border:1px solid #2e3b53;border-radius:10px;padding:6px 10px;background:#0b1220}
    @keyframes blink-opacity { 50% { opacity: 0.2; } }
    .pruef-bar-finished { border-color: transparent !important; }
    .blinking-red-final { background: #ef4444 !important; animation: blink-opacity 1.5s infinite; }
    @keyframes blink-green { 50% { background-color: #22c55e80; } }
    .blinking-green { background-color: #22c55e !important; animation: blink-green 2s infinite; }
    .prufung-type-short { border: 1px solid var(--line) !important; }
    .prufung-type-long { border: 2px solid var(--text) !important; font-weight: bold; padding-left: 1rem !important; padding-right: 1rem !important; }
    .next-ready-checkbox:not(:checked) { filter: grayscale(1); }
  </style>
</head>
<body>
  <header class="wrap">
    <div id="urgent-notifications" class="space-y-2 mb-3"></div>
    <div class="panel">
      <div class="head">
        <div class="flex items-center gap-4">
          <img src="https://www.sanner-group.com/typo3conf/ext/sanner_site/Resources/Public/Icons/Sanner-Icons/Sanner-Logo-Claim.svg" alt="Sanner Logo" class="h-10">
          <div class="loginbar flex items-center gap-3 relative">
            <img id="userAvatar" src="https://placehold.co/40" alt="Avatar" class="w-8 h-8 rounded-full cursor-pointer">
            <div class="flex flex-col items-start">
              <div>
                <strong id="loginName">Kamil Kowalczyk</strong>
                <small id="loginId" class="opacity-70">(SoG1917)</small>
              </div>
              <span id="loginRole" class="role-badge" style="display: none;"></span>
            </div>
            <select id="loginSelect" class="btn"></select>

            <div class="user-info-popup">
            <div class="panel">
              <div class="body user-info-popup-grid">
                <img id="popupUserAvatar" src="https://placehold.co/184" alt="User Avatar">
                <div>
                  <h3 id="popupUserName" class="font-bold text-lg">Imię Nazwisko</h3>
                  <p id="popupUserRole" class="text-sm"></p>
                  <p class="text-xs mt-2">Ostatnio zalogowany: <span id="popupLastLogin">teraz</span></p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="flex items-center gap-4">
            <div id="langSwitcher" class="flex gap-2">
              <button class="btn ghost text-xl" data-lang="pl" title="Polski">🇵🇱</button>
              <button class="btn ghost text-xl" data-lang="en" title="English">🇬🇧</button>
              <button class="btn ghost text-xl" data-lang="tr" title="Türkçe">🇹🇷</button>
              <button class="btn ghost text-xl" data-lang="de" title="Deutsch">🇩🇪</button>
              <button class="btn ghost text-xl" data-lang="ar" title="العربية">🇸🇦</button>
            </div>
            <div id="themeSwitcher" class="flex items-center gap-2">
              <button class="w-4 h-4 rounded-full border-2 border-white/20" style="background-color: #0e1117" data-theme="dark" title="Dark Theme"></button>
              <button class="w-4 h-4 rounded-full border-2 border-black/20" style="background-color: #f3f4f6" data-theme="light" title="Light Theme"></button>
              <button class="w-4 h-4 rounded-full border-2 border-white/20" style="background-color: #0c1424" data-theme="blue" title="Blue Theme"></button>
              <button class="w-4 h-4 rounded-full border-2 border-white/20" style="background-color: #052e16" data-theme="green" title="Green Theme"></button>
            </div>
            <button id="settingsBtn" class="btn ghost text-2xl">⚙️</button>
        </div>
      </div>
      <div class="body">
        <h1 class="m-0" data-translate-key="appTitle">🏭 Kartonowy Napełniacz</h1>
        <div id="statusLine" class="opacity-80 mt-1" data-translate-key="statusReady"></div>
        <div id="chatStream" class="alerts mt-2"></div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section id="machines" class="machines"></section>

    <div id="newUserModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4">
      <div class="panel w-full max-w-md">
        <div class="head">
          <h2 class="m-0" data-translate-key="createUserTitle">Tworzenie nowego użytkownika</h2>
          <button id="closeModalBtn" class="btn ghost">✖</button>
        </div>
        <div class="body">
          <form id="newUserForm" class="flex flex-col gap-4">
            <input type="text" id="newLogin" name="login" class="btn" data-translate-key="placeholderLogin" placeholder="Login (np. SoGxxxx, LK12, 1234)" required pattern="^(SoG[0-9]{4}|LK[0-9]{2}|[0-9]{2}|[0-9]{4})$">
            <input type="password" id="newPassword" name="password" class="btn" data-translate-key="placeholderPassword" placeholder="Hasło (opcjonalne)">
            <input type="text" id="newName" name="name" class="btn" data-translate-key="placeholderName" placeholder="Imię i nazwisko" required>
            <button type="submit" class="btn primary" data-translate-key="createUserBtn">Stwórz użytkownika</button>
          </form>
        </div>
      </div>
    </div>

    <section class="panel mt-3">
      <div class="head"><h2 class="m-0" data-translate-key="notesTitle">💬 CHAT</h2></div>
      <div class="body">
        <div class="flex gap-2 flex-wrap">
          <input id="noteInput" class="btn" style="flex:1" data-translate-key="placeholderNote" placeholder="Wpisz wiadomość...">
          <button id="addNote" class="btn primary" data-translate-key="addNoteBtn">Wyślij</button>
        </div>
        <div id="notesList" class="notes-list mt-2"></div>
      </div>
    </section>

    <section class="panel mt-3">
      <div class="head"><h2 class="m-0" data-translate-key="plansTitle">📌 Dalsze plany</h2></div>
      <div class="body">
        <div class="flex gap-2 flex-wrap">
          <input id="planInput" class="btn" style="flex:1" data-translate-key="placeholderPlan" placeholder="Nowy pomysł / zadanie…">
          <button id="addPlan" class="btn" data-translate-key="addPlanBtn">+ Dodaj plan</button>
        </div>
        <div id="plansList" class="notes-list mt-2"></div>
      </div>
    </section>
  </main>

  <div id="userDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-40">
    <div class="panel w-full max-w-md">
      <div class="head">
        <h2 class="m-0">Uzupełnij swoje dane</h2>
      </div>
      <div class="body">
        <form id="userDetailsForm" class="flex flex-col gap-4">
          <p>To jest Twoje pierwsze logowanie. Prosimy o uzupełnienie danych. Pola są opcjonalne.</p>
          <input type="text" id="detailsName" name="name" class="btn" placeholder="Imię i nazwisko">
          <input type="text" id="detailsDob" name="dob" class="btn" placeholder="Data urodzenia (DD.MM.RRRR)">
          <select id="detailsLang" name="lang" class="btn">
            <option value="pl">Polski</option>
            <option value="en">English</option>
            <option value="tr">Türkçe</option>
            <option value="de">Deutsch</option>
            <option value="ar">العربية</option>
          </select>
          <button type="submit" class="btn primary">Zapisz i kontynuuj</button>
        </form>
      </div>
    </div>
  </div>

  <div id="colorPicker" class="hidden absolute panel p-2 z-20">
    <div class="grid grid-cols-4 gap-2">
      <button class="w-6 h-6 rounded-full" style="background-color: #ef4444;" data-color="#ef4444"></button>
      <button class="w-6 h-6 rounded-full" style="background-color: #f97316;" data-color="#f97316"></button>
      <button class="w-6 h-6 rounded-full" style="background-color: #eab308;" data-color="#eab308"></button>
      <button class="w-6 h-6 rounded-full" style="background-color: #84cc16;" data-color="#84cc16"></button>
      <button class="w-6 h-6 rounded-full" style="background-color: #22c55e;" data-color="#22c55e"></button>
      <button class="w-6 h-6 rounded-full" style="background-color: #14b8a6;" data-color="#14b8a6"></button>
      <button class="w-6 h-6 rounded-full" style="background-color: #3b82f6;" data-color="#3b82f6"></button>
      <button class="w-6 h-6 rounded-full" style="background-color: #a855f7;" data-color="#a855f7"></button>
      <button class="w-6 h-6 rounded-full" style="background-color: #ec4899;" data-color="#ec4899"></button>
      <button class="w-6 h-6 rounded-full bg-white border" data-color="#ffffff"></button>
      <button class="w-6 h-6 rounded-full bg-slate-400" data-color="#94a3b8"></button>
      <button class="w-6 h-6 rounded-full bg-black border" data-color="#000000"></button>
    </div>
  </div>

  <div id="customTimeModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-20">
    <div class="panel w-full max-w-xs">
      <div class="head">
        <h2 class="m-0">Ustaw czas</h2>
        <button id="closeTimeModalBtn" class="btn ghost">✖</button>
      </div>
      <div class="body">
        <form id="customTimeForm" class="flex flex-col gap-4">
          <input type="number" id="customTimeInput" name="minutes" class="btn text-center text-lg" placeholder="Minuty" required>
          <button type="submit" class="btn primary">Ustaw</button>
        </form>
      </div>
    </div>
  </div>

  <div id="customConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
    <div class="panel w-full max-w-sm">
      <div class="body space-y-4">
        <p id="customConfirmMessage" class="text-center">Czy na pewno chcesz to zrobić?</p>
        <div class="flex justify-center gap-4">
          <button id="customConfirmCancel" class="btn">Anuluj</button>
          <button id="customConfirmOk" class="btn primary">OK</button>
        </div>
      </div>
    </div>
  </div>

  <footer class="wrap" id="adminFooter" style="display: none;">
    <div class="panel mt-3">
      <div class="head">
        <h2 class="m-0">🔧 Panel Admina</h2>
      </div>
      <div class="body">
        <p>Tutaj znajdą się opcje administracyjne, takie jak zarządzanie użytkownikami i ich uprawnieniami.</p>
        <div id="loginHistory" class="mt-4">
            <h3 class="font-bold border-b border-white/10 pb-1">Historia logowań</h3>
            <div id="loginHistoryList" class="notes-list mt-2 max-h-60 overflow-y-auto"></div>
        </div>
      </div>
    </div>
  </footer>

  <template id="tpl-machine">
    <article class="panel machine">
      <div class="head">
        <div class="title"><span>🤖</span><h2 class="code"></h2></div>
        <div class="flex items-center gap-2">
          <span class="text-xs opacity-70">Przewidywany czas do końca:</span>
          <div class="completion-badge role-badge bg-gray-500 text-white">--:--</div>
          <button class="btn ghost settings-toggle">⚙️</button>
        </div>
      </div>
      <div class="body">
        <div class="meta text-sm space-y-2">
          <div class="grid grid-cols-2 gap-2">
            <div class="border border-white/10 rounded-lg p-2">
              <span data-translate-key="auftrag">Auftrag:</span>
              <strong class="auf-val block font-bold text-base">—</strong>
            </div>
            <div class="border border-white/10 rounded-lg p-2">
              <span data-translate-key="nextAuftrag">Następny Auftrag:</span>
              <strong class="nextauf-val block font-bold text-base">—</strong>
            </div>
          </div>
          <div class="border border-white/10 rounded-lg p-2">
            <div class="flex items-center gap-2">
                <span data-translate-key="model">Model:</span>
                <strong class="mdl-val font-bold text-base">—</strong>
                <span class="w-6 h-6 rounded-full bg-white/50 border-2 border-white/20 model-color-dot ml-auto" title="Zmień kolor"></span>
            </div>
          </div>
          <div class="border border-white/10 rounded-lg p-2">
            <span data-translate-key="period">Okres:</span>
            <strong class="period-val block font-bold">—</strong>
          </div>
        </div>

        <div class="carton-progress grid grid-cols-2 grid-rows-2 gap-1.5 w-32 h-40 mx-auto mt-3">
          <div class="carton-box" data-carton-id="1"><div class="carton-fill"></div><div class="carton-label">#1</div></div>
          <div class="carton-box" data-carton-id="3"><div class="carton-fill"></div><div class="carton-label">#3</div></div>
          <div class="carton-box" data-carton-id="2"><div class="carton-fill"></div><div class="carton-label">#2</div></div>
          <div class="carton-box" data-carton-id="4"><div class="carton-fill"></div><div class="carton-label">#4</div></div>
        </div>

        <div class="pruef">
          <div class="pr-bar">
            <div class="pr-fill"></div><div class="pr-label">60:00</div>
            <div class="pr-buttons absolute right-[85px] top-1/2 -translate-y-1/2 flex gap-1">
              <button class="btn ghost !p-1 text-xs" data-time="3600">1H</button>
              <button class="btn ghost !p-1 text-xs" data-time="7200">2H</button>
              <button class="btn ghost !p-1 text-xs" data-time="10800">3H</button>
              <button class="btn ghost !p-1 text-xs" data-time="custom" data-translate-key="customTime">WŁASNY</button>
            </div>
            <div class="pr-reset">Reset</div>
          </div>
        </div>

        <div class="machine-settings hidden mt-4 space-y-2">
          <h4 class="font-bold border-b border-white/10 pb-1">Ustawienia</h4>
          <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm items-center">
            <label>Model:</label>
            <input type="text" class="setting-input btn text-sm" data-source="order" data-key="model">
            <label>Czas (min):</label>
            <input type="number" class="setting-input btn text-sm w-24" data-source="machine" data-key="durationMin">
            <label>Czas ukończenia:</label>
            <input type="text" class="setting-input btn text-sm" data-source="machine" data-key="completionTimestamp" placeholder="YYYY-MM-DD HH:MM:SS">
            <label>Następny gotowy:</label>
            <input type="checkbox" class="setting-input h-5 w-5" data-source="order" data-key="nextReady">
          </div>
           <small class="text-xs opacity-60">Wciśnij ENTER (lub zmień pole), aby zapisać.</small>
        </div>

      </div>
    </article>
  </template>

  <script>
    // --- basic state
    const ORDERS_KEY='KN_ORDERS_V1';
    const NOTES_KEY='KN007_NOTES';
    const PLANS_KEY='KN007_PLANS';
    const ADMIN_PASS = 4753; // kod 0..1000 wymagany do publikacji SoG1917

    const TRANSLATIONS = {
      pl: {
        appTitle: '🏭 Kartonowy Napełniacz', createUserTitle: 'Tworzenie nowego użytkownika',
        placeholderLogin: 'Login (np. SoGxxxx lub LK12)', placeholderPassword: 'Hasło', placeholderName: 'Imię i nazwisko',
        createUserBtn: 'Stwórz użytkownika', notesTitle: '💬 CHAT', placeholderNote: 'Wpisz wiadomość...', addNoteBtn: 'Wyślij',
        plansTitle: '📌 Dalsze plany', placeholderPlan: 'Nowy pomysł / zadanie…', addPlanBtn: '+ Dodaj plan', refreshBtn: '↻ Odśwież z MySQL',
        auftrag: 'Auftrag:', nextAuftrag: 'Następny Auftrag:', model: 'Model:', period: 'Okres:', pruefungTime: '🧪 Prüfung — czas:', customTime: 'WŁASNY',
      },
      en: {
        appTitle: '🏭 Cardboard Filler', createUserTitle: 'Create new user',
        placeholderLogin: 'Login (e.g. SoGxxxx or LK12)', placeholderPassword: 'Password', placeholderName: 'First and last name',
        createUserBtn: 'Create User', notesTitle: '💬 CHAT', placeholderNote: 'Enter a message...', addNoteBtn: 'Send',
        plansTitle: '📌 Future plans', placeholderPlan: 'New idea / task…', addPlanBtn: '+ Add plan', refreshBtn: '↻ Refresh from MySQL',
        auftrag: 'Order:', nextAuftrag: 'Next Order:', model: 'Model:', period: 'Period:', pruefungTime: '🧪 Prüfung — time:', customTime: 'CUSTOM',
      },
      de: {
        appTitle: '🏭 Karton-Füller', createUserTitle: 'Neuen Benutzer erstellen',
        placeholderLogin: 'Login (z.B. SoGxxxx oder LK12)', placeholderPassword: 'Passwort', placeholderName: 'Vor- und Nachname',
        createUserBtn: 'Benutzer erstellen', notesTitle: '💬 CHAT', placeholderNote: 'Nachricht eingeben…', addNoteBtn: 'Senden',
        plansTitle: '📌 Weitere Pläne', placeholderPlan: 'Neue Idee / Aufgabe…', addPlanBtn: '+ Plan hinzufügen', refreshBtn: '↻ Von MySQL aktualisieren',
        auftrag: 'Auftrag:', nextAuftrag: 'Nächster Auftrag:', model: 'Modell:', period: 'Zeitraum:', pruefungTime: '🧪 Prüfung — Zeit:', customTime: 'EIGENE',
      },
      tr: {
        appTitle: '🏭 Karton Doldurucu', createUserTitle: 'Yeni kullanıcı oluştur',
        placeholderLogin: 'Giriş (ör. SoGxxxx veya LK12)', placeholderPassword: 'Şifre', placeholderName: 'Ad ve soyad',
        createUserBtn: 'Kullanıcı Oluştur', notesTitle: '💬 SOHBET', placeholderNote: 'Bir mesaj girin...', addNoteBtn: 'Gönder',
        plansTitle: '📌 Gelecek planları', placeholderPlan: 'Yeni fikir / görev…', addPlanBtn: '+ Plan ekle', refreshBtn: '↻ MySQL\'den yenile',
        auftrag: 'Sipariş:', nextAuftrag: 'Sonraki Sipariş:', model: 'Model:', period: 'Dönem:', pruefungTime: '🧪 Test — süre:', customTime: 'ÖZEL',
      },
      ar: {
        appTitle: '🏭 حشو الكرتون', createUserTitle: 'إنشاء مستخدم جديد',
        placeholderLogin: 'تسجيل الدخول (على سبيل المثال SoGxxxx أو LK12)', placeholderPassword: 'كلمة المرور', placeholderName: 'الاسم الأول والأخير',
        createUserBtn: 'إنشاء مستخدم', notesTitle: '💬 دردشة', placeholderNote: 'أدخل رسالة…', addNoteBtn: 'إرسال',
        plansTitle: '📌 خطط مستقبلية', placeholderPlan: 'فكرة / مهمة جديدة…', addPlanBtn: '+ إضافة خطة', refreshBtn: '↻ تحديث من MySQL',
        auftrag: 'طلب:', nextAuftrag: 'الطلب التالي:', model: 'نموذج:', period: 'فترة:', pruefungTime: '🧪 فحص — الوقت:', customTime: 'مخصص',
      }
    };

    let USERS = {
      'SoG1917': { name: 'Kamil Kowalczyk', avatar: '', password: String(ADMIN_PASS) },
      'SoG2025': { name: 'John Locke', avatar: '' },
      'SoG1':    { name: 'Michael Scott', avatar: '' },
      'SoG1899': { name: 'James Corden', avatar: '' },
      'SoP1':    { name: 'Piotr Nowak', avatar: '' },
      'SoG2200': { name: 'User 2200', avatar: '' },
      'SoG2020': { name: 'User 2020', avatar: '' },
    };

    const DEFAULTS={
      user: { uid: 'SoG1917' },
      users: USERS,
      machines:[
        { code:'MA820061', durationMin:25, pruef:3600 },
        { code:'MA820062',  durationMin:22, pruef:3600 },
        { code:'MA820063', durationMin:25, pruef:3600 },
        { code:'MA820064', durationMin:25, pruef:3600 },
        { code:'MA820051', durationMin:25, pruef:3600, color: '#ffffff' },
        { code:'MA820054', durationMin:25, pruef:3600, color: '#ffffff' },
      ],
      orders:{
        'MA820051': { model: 'DASG-1 (201044)' },
        'MA820054': { model: 'DASG-1 (201044)' }
      },
    };
    let CFG=JSON.parse(localStorage.getItem('KN007_CFG')||'null')||DEFAULTS;
    // ensure USERS is up to date
    if (CFG.users) { USERS = CFG.users; } else { CFG.users = USERS; }

    const $=(s,r=document)=>r.querySelector(s), $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const isAdmin=()=> CFG.user?.uid==='SoG1917';
    function persist(){ localStorage.setItem('KN007_CFG', JSON.stringify(CFG)); }
    function setStatus(t){ $('#statusLine').textContent='Status: '+t; }

    // --- kv storage via php
    async function saveShared(key,json){ try{ const res=await fetch('storage.php?a=set&key='+encodeURIComponent(key),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(json)}); const j=await res.json(); return !!j.ok; }catch(e){ console.error(e); return false; } }
    async function loadShared(key){ try{ const res=await fetch('storage.php?a=get&key='+encodeURIComponent(key)); const j=await res.json(); return j.v?JSON.parse(j.v):null; }catch(e){ console.error(e); return null; } }

    // --- machines (minimal for 0.007 look)
    let activePruefung = null;
    class Pruefung{
      constructor(root){
        this.root=root;
        this.fill=$('.pr-fill',root);
        this.label=$('.pr-label',root);
        this.buttons=$$('.pr-buttons button',root);
        this.reset=$('.pr-reset',root);
        this.bar=$('.pr-bar', root);
        this.customButton = this.buttons.find(b => b.dataset.time === 'custom');

        this.total=3600;
        this.start=Date.now();
        this.prufungType = 'short';

        this.bind();
        this.updateCustomButtonBorder();
        this.tick();
      }

      updateCustomButtonBorder() {
        this.customButton.classList.remove('prufung-type-short', 'prufung-type-long');
        this.customButton.classList.add(this.prufungType === 'short' ? 'prufung-type-short' : 'prufung-type-long');
      }

      togglePrufungType() {
        this.prufungType = this.prufungType === 'short' ? 'long' : 'short';
        this.customButton.textContent = this.prufungType === 'short' ? 'Short' : 'Long 📏';
        this.updateCustomButtonBorder();
      }

      bind(){
        this.buttons.forEach(btn => {
            const v = btn.dataset.time;
            if (v === 'custom') {
                btn.textContent = 'Short';
                btn.addEventListener('click', () => this.togglePrufungType());
            } else {
                btn.addEventListener('click', () => {
                    this.buttons.forEach(b => b.classList.remove('primary'));
                    btn.classList.add('primary');
                    this.total = parseInt(v, 10);
                    this.start = Date.now();
                    this.togglePrufungType();
                });
            }
        });

        this.reset.addEventListener('click', () => {
            this.start=Date.now();
            this.buttons.forEach(b => b.classList.remove('primary'));
            this.togglePrufungType();
        });

        this.bar.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            activePruefung = this;
            $('#customTimeModal').classList.remove('hidden');
            $('#customTimeInput').focus();
        });
      }

      setTime(minutes) {
        this.total = Math.max(60, (parseInt(minutes, 10) || 0) * 60);
        this.start = Date.now();
        this.buttons.forEach(b => b.classList.remove('primary'));
        this.togglePrufungType();
      }

      tick(){
        const el = Math.min(this.total, Math.floor((Date.now()-this.start)/1000));
        const left = this.total-el;
        const pct = this.total > 0 ? (el / this.total) : 0;

        this.fill.style.width = (pct * 100) + '%';

        if (left <= 0) {
            if (!this.bar.classList.contains('pruef-bar-finished')) {
                this.bar.classList.add('pruef-bar-finished');
                this.fill.classList.remove('blinking-red-final'); // remove old animation class
                this.fill.classList.add('blinking-red-final'); // add new one
                this.label.style.display = 'none';
            }
        } else {
            if (this.bar.classList.contains('pruef-bar-finished')) {
                this.bar.classList.remove('pruef-bar-finished');
                this.fill.classList.remove('blinking-red-final');
                this.label.style.display = 'flex';
            }
            const hue = 120 * (1 - pct);
            this.fill.style.background = `linear-gradient(90deg, hsl(${hue}, 80%, 50%), hsl(${hue}, 80%, 65%))`;
        }

        const mm = String(Math.floor(left/60)).padStart(2,'0'), ss = String(left%60).padStart(2,'0');
        this.label.textContent = `${mm}:${ss}`;

        requestAnimationFrame(()=>this.tick());
      }
    }

    class CartonProgress {
        constructor(container, machineData, orderData) {
            this.container = container;
            this.boxes = $$('.carton-box', container);
            this.fills = $$('.carton-fill', container);
            this.labels = $$('.carton-label', container);

            this.sequence = [0, 3, 1, 2]; // 0-indexed for visual layout: 1->4->2->3
            this.state = {
                currentCartonSequenceIndex: 0,
                startTime: Date.now(),
                cartons: [
                    { id: 1, progress: 0, label: '#1' },
                    { id: 2, progress: 0, label: '#2' },
                    { id: 3, progress: 0, label: '#3' },
                    { id: 4, progress: 0, label: '#4' }
                ]
            };
            this.durationPerCarton = (machineData.durationMin || 25) * 60 * 1000 / 4;

            this.bindEvents();
            this.tick();
        }

        bindEvents() {
            this.boxes.forEach((box, index) => {
                box.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    const cartonId = parseInt(box.dataset.cartonId, 10);
                    showCustomConfirm(`Zresetować karton #${cartonId}?`, (confirmed) => {
                        if (confirmed) {
                            this.resetCarton(index);
                        }
                    });
                });
            });
        }

        resetCarton(visualIndex) {
            const cartonDataIndex = this.state.cartons.findIndex(c => this.sequence[c.id -1] === visualIndex);
            // This is getting complicated. Let's simplify. The visual index IS the carton index for binding.
            const cartonId = visualIndex + 1; // assuming visual order is 0,1,2,3

            this.state.currentCartonSequenceIndex = this.sequence.indexOf(visualIndex);
            this.state.startTime = Date.now();

            // Reset all fills
            this.fills.forEach(fill => {
                fill.style.height = '0%';
                fill.classList.remove('blinking-green');
            });
        }

        tick() {
            if (this.state.currentCartonSequenceIndex >= this.sequence.length) {
                // All cartons are full, just ensure the last one blinks
                const lastCartonVisualIndex = this.sequence[this.sequence.length - 1];
                if (!this.fills[lastCartonVisualIndex].classList.contains('blinking-green')) {
                    this.fills[lastCartonVisualIndex].classList.add('blinking-green');
                }
                requestAnimationFrame(() => this.tick());
                return;
            }

            const now = Date.now();
            const elapsedTime = now - this.state.startTime;
            const progress = Math.min(1, elapsedTime / this.durationPerCarton);

            const activeCartonVisualIndex = this.sequence[this.state.currentCartonSequenceIndex];
            this.fills[activeCartonVisualIndex].style.height = (progress * 100) + '%';

            if (progress >= 1) {
                this.fills[activeCartonVisualIndex].classList.add('blinking-green');
                this.state.currentCartonSequenceIndex++;
                this.state.startTime = Date.now(); // Reset timer for the next carton
            }

            requestAnimationFrame(() => this.tick());
        }
    }

    let activeMachineForColor = null;
    class Machine{ constructor(container,data,orders){ this.root=$('#tpl-machine').content.firstElementChild.cloneNode(true);
        this.data = data;
        this.orders = orders;
        this.code=data.code; $('.code',this.root).textContent=this.code;

        if (!this.data.completionTimestamp) {
          this.data.completionTimestamp = Date.now() + (Math.floor(Math.random() * 14940) + 60) * 1000;
        }

        this.dot = $('.model-color-dot', this.root);
        this.dot.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            PickerManager.open(this, e);
        });

        this.completionBadgeEl = $('.completion-badge', this.root);

        this.settingsToggle = $('.settings-toggle', this.root);
        this.settingsPanel = $('.machine-settings', this.root);
        this.settingsInputs = $$('.setting-input', this.settingsPanel);

        this.settingsToggle.addEventListener('click', () => this.settingsPanel.classList.toggle('hidden'));
        this.settingsInputs.forEach(input => {
            const eventType = input.type === 'checkbox' ? 'change' : 'keyup';
            input.addEventListener(eventType, (e) => {
                if (eventType === 'change' || e.key === 'Enter') {
                    this.saveSetting(e.target);
                }
            });
        });

        container.appendChild(this.root);
        this.pr = new Pruefung($('.pruef', this.root));
        this.cartons = new CartonProgress($('.carton-progress', this.root), data, this.orders);

        this.render();
        this.updateCompletionTime(); // Initial call
        this.completionInterval = setInterval(() => this.updateCompletionTime(), 60000); // Refresh every minute
    }
      saveSetting(input) {
        const key = input.dataset.key;
        const source = input.dataset.source;
        let value;

        if (input.type === 'checkbox') {
            value = input.checked;
        } else if (input.type === 'number') {
            value = parseFloat(input.value) || 0;
        } else {
            value = input.value;
        }

        if (key === 'completionTimestamp' && typeof value === 'string' && value.includes('-')) {
            value = new Date(value).getTime();
            if (isNaN(value)) {
                alert('Nieprawidłowy format daty!');
                return;
            }
        }

        if (source === 'machine') {
            this.data[key] = value;
        } else if (source === 'order') {
            if (!this.orders[this.code]) this.orders[this.code] = genOrder();
            this.orders[this.code][key] = value;
        }

        input.blur();
        this.render();
        persist();
        setStatus('Zapisano ' + key);
      }
      render() {
        const order = this.orders[this.code] || {};
        $('.auf-val',this.root).textContent = order.auftrag || '—';
        $('.mdl-val',this.root).textContent = order.model || '—';
        $('.period-val',this.root).textContent = order.period || '—';
        $('.nextauf-val',this.root).textContent = order.next || '—';

        this.dot.style.backgroundColor = this.data.color || '#94a3b8';

        // Populate settings inputs
        this.settingsInputs.forEach(input => {
            const key = input.dataset.key;
            const source = input.dataset.source;
            let value;
            if (source === 'machine') {
                value = this.data[key];
            } else if (source === 'order') {
                value = order[key];
            }

            if (input.type === 'checkbox') {
                input.checked = !!value;
            } else if (key === 'completionTimestamp' && value) {
                input.value = new Date(value).toISOString().slice(0, 19).replace('T', ' ');
            } else {
                input.value = value || '';
            }
        });
      }
      setColor(color) {
        this.data.color = color;
        this.render();
        persist();
      }
      updateCompletionTime() {
        const now = Date.now();
        const timeLeft = Math.max(0, Math.floor((this.data.completionTimestamp - now) / 1000));
        const hours = Math.floor(timeLeft / 3600);
        const minutes = Math.floor((timeLeft % 3600) / 60);
        this.completionBadgeEl.textContent = `${String(hours)}h ${String(minutes).padStart(2, '0')}m`;

        // Color logic
        const fifteenHours = 15 * 3600;
        const eightHours = 8 * 3600;
        const twoHours = 2 * 3600;
        const oneHour = 1 * 3600;

        let badgeColorClass = 'bg-gray-500'; // > 15h
        if (timeLeft <= fifteenHours && timeLeft > eightHours) {
            badgeColorClass = 'bg-yellow-500'; // 8-15h
        } else if (timeLeft <= eightHours && timeLeft > twoHours) {
            badgeColorClass = 'bg-orange-500'; // 2-8h
        } else if (timeLeft <= twoHours && timeLeft > 0) {
            badgeColorClass = 'bg-red-600'; // < 2h
        }

        this.completionBadgeEl.className = 'completion-badge role-badge text-white'; // Reset classes
        this.completionBadgeEl.classList.add(badgeColorClass);

        // Urgent notification logic
        if (timeLeft > 0 && timeLeft < twoHours) {
            if (timeLeft < oneHour) {
                showUrgentNotification(this.code, `Koniec Auftragu ${this.code} w ciągu godziny!`, 'danger');
            } else {
                showUrgentNotification(this.code, `Koniec Auftragu ${this.code} w ciągu 2 godzin!`, 'warning');
            }
        } else {
            hideUrgentNotification(this.code);
        }
      }
    }

    function genOrder(){ const rnd=String(Math.floor(Math.random()*10000)).padStart(4,'0'); const s=new Date(); const e=new Date(); e.setDate(s.getDate()+5);
      const F=d=>`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`;
      return { auftrag:'1012'+rnd, model:'DASG-1 (201044)', period:`od ${F(s)} do ${F(e)}`, next:'' };
    }

    function renderMachines(){ const box=$('#machines'); box.innerHTML=''; (CFG.machines||[]).forEach(m=> new Machine(box,m, CFG.orders||{})); }

    // --- stamps
    function makeStamp(ts,user,smaller=false){
      const d=new Date(ts);
      const dd=String(d.getDate()).padStart(2,'0'), mm=String(d.getMonth()+1).padStart(2,'0'), yyyy=d.getFullYear();
      const hh=String(d.getHours()).padStart(2,'0'), min=String(d.getMinutes()).padStart(2,'0');
      const small=smaller?' small':'';
      return `<span class="stamp">
        <span class="chip small digits${small}">[${dd}/${mm}/${yyyy}]</span>
        <span class="chip small digits${small}">[${hh}:${min}]</span>
        <span class="chip small">${user.uid} (${user.name})</span>
      </span>`;
    }

    // --- chat stream
    function chatPush(text){ const el=document.createElement('div'); el.className='alert'; el.innerHTML=`<span>💬 ${text}</span> <button class="btn ghost">✖</button>`; $('.btn',el).onclick=()=>el.remove(); $('#chatStream').prepend(el); }

    // --- notes / plans
    let NOTES=[], PLANS=[];
    function renderNotes(){
      const list=$('#notesList'); list.innerHTML='';
      NOTES.forEach(n=>{
        const row=document.createElement('div'); row.className='row';
        const tag = n.status==='DRAFT' ? '<span class="tag draft">DRAFT</span>' : '';
        row.innerHTML=`<div class="meta">${makeStamp(n.ts, {uid:n.user,name:n.userName})} ${tag}</div>
                       <div class="txt">${n.text}</div>
                       <div class="act"></div>`;
        const act=$('.act',row);
        if(isAdmin()){
          const bE=document.createElement('button'); bE.className='btn'; bE.textContent='✏️'; bE.title='Edytuj';
          const bR=document.createElement('button'); bR.className='btn'; bR.textContent='↩️'; bR.title='Odpowiedz';
          const bD=document.createElement('button'); bD.className='btn'; bD.textContent='🗑️'; bD.title='Usuń';
          bE.onclick=async()=>{ const v=prompt('Edytuj notatkę', n.text); if(v!=null){ n.text=v; await saveNotes(); renderNotes(); } };
          bR.onclick=async()=>{ const v=prompt('Odpowiedź', ''); if(v){ NOTES.push({id:Date.now()+Math.random(), ts:Date.now(), user:CFG.user.uid, userName:CFG.user.name, text:`↪ ${v} (odpowiedź na #${n.id})`, status:'FINAL'}); await saveNotes(); renderNotes(); } };
          bD.onclick=async()=>{ if(confirm('Usunąć notatkę?')){ NOTES = NOTES.filter(x=>x.id!==n.id); await saveNotes(); renderNotes(); } };
          act.append(bE,bR,bD);
        }
        list.appendChild(row);
      });
    }
    function renderPlans(){
      const list=$('#plansList'); list.innerHTML='';
      PLANS.forEach(p=>{
        const row=document.createElement('div'); row.className='row';
        row.innerHTML=`<div class="meta">${makeStamp(p.ts, {uid:p.user,name:p.userName}, true)}</div>
                       <div class="txt">${p.text}</div>`;
        list.appendChild(row);
      });
    }
    async function saveNotes(){ await saveShared(NOTES_KEY, NOTES); }
    async function loadNotes(){ const db=await loadShared(NOTES_KEY); if(db){ NOTES=db; } renderNotes(); }
    async function savePlans(){ await saveShared(PLANS_KEY, PLANS); }
    async function loadPlans(){ const db=await loadShared(PLANS_KEY); if(db){ PLANS=db; } renderPlans(); }

    // --- login
    function getUserRole(uid) {
        if (!uid) return null;
        const ROLES = {
            'SoG1917': { name: 'Senior Developer', className: 'role-senior-dev' },
            'SoG2025': { name: 'TeamLeiter', className: 'role-teamleiter' },
            'SoG2200': { name: 'Einrichter', className: 'role-einrichter' },
            'SoG2020': { name: 'Einrichter', className: 'role-einrichter' },
        };
        if (ROLES[uid]) return ROLES[uid];
        if (uid.startsWith('SoG')) return { name: 'Administrator', className: 'role-admin' };
        if (uid.startsWith('LK')) return { name: 'Leiharbeiter', className: 'role-leiharbeiter' };
        if (uid.startsWith('SoP')) return { name: 'Administrator', className: 'role-admin' };
        return { name: 'Użytkownik', className: 'role-user' };
    }

    function showUser(){
      const uid = CFG.user?.uid;
      const user = USERS[uid] || { name: 'Nieznany', avatar: '' };

      $('#loginName').textContent = user.name;
      $('#loginId').textContent = uid || '';
      const avatarSrc = user.avatar || 'https://placehold.co/40/0e1117/ffffff?text=' + (user.name?.[0] || '?');
      $('#userAvatar').src = avatarSrc;

      const role = getUserRole(uid);
      const roleEl = $('#loginRole');
      if (role) {
        roleEl.textContent = role.name;
        roleEl.className = 'role-badge ' + role.className;
        roleEl.style.display = 'inline-block';
      } else {
        roleEl.style.display = 'none';
      }

      // Update popup
      $('#popupUserAvatar').src = user.avatar || 'https://placehold.co/184/0e1117/ffffff?text=' + (user.name?.[0] || '?');
      $('#popupUserName').textContent = user.name;
      $('#popupUserRole').textContent = role ? role.name : 'Użytkownik';
    }

    function showUserDetailsModal() {
        const currentUser = USERS[CFG.user.uid];
        if (currentUser) {
            $('#detailsName').value = currentUser.name || '';
            $('#detailsLang').value = CFG.language || 'pl';
        }
        $('#userDetailsModal').classList.remove('hidden');
    }

    function initUserDetailsModal() {
        $('#userDetailsForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const user = USERS[CFG.user.uid];
            if (user) {
                user.name = $('#detailsName').value;
                user.dob = $('#detailsDob').value; // Just store it as text
                user.details_filled = true;

                const selectedLang = $('#detailsLang').value;
                setLanguage(selectedLang); // This also persists the language choice

                CFG.users = USERS;
                persist();

                // Re-render user info in header and reload
                showUser();
                $('#userDetailsModal').classList.add('hidden');
                window.location.reload();
            }
        });
    }

    function initLogin(){
      const loginSelect = $('#loginSelect');

      // Populate select
      loginSelect.innerHTML = '<option value="new_user">+ Nowy użytkownik</option>';
      for (const uid in USERS) {
        const user = USERS[uid];
        const option = document.createElement('option');
        option.value = uid;
        option.textContent = `${user.name} (${uid})`;
        loginSelect.appendChild(option);
      }

      loginSelect.value = CFG.user.uid;
      showUser();

      // Check if we need to ask for details on initial load
      const currentUser = USERS[CFG.user.uid];
      if (currentUser && !currentUser.details_filled) {
        showUserDetailsModal();
      }

      loginSelect.addEventListener('change', () => {
        const selectedValue = loginSelect.value;
        if (selectedValue === 'new_user') {
          $('#newUserModal').classList.remove('hidden');
          loginSelect.value = CFG.user.uid; // revert selection
          return;
        }

        const userToLogin = USERS[selectedValue];
        if (userToLogin && userToLogin.password) {
          const pass = prompt(`Wprowadź hasło dla ${selectedValue}:`);
          if (pass !== userToLogin.password) {
            alert('Błędne hasło!');
            loginSelect.value = CFG.user.uid; // revert
            return;
          }
        }

        logLogin(selectedValue);
        CFG.user.uid = selectedValue;
        persist();

        const newCurrentUser = USERS[selectedValue];
        if (newCurrentUser && !newCurrentUser.details_filled) {
            showUser(); // update header immediately
            showUserDetailsModal();
        } else {
            window.location.reload();
        }
      });

      $('#userAvatar').addEventListener('click', () => {
        const newAvatar = prompt('Podaj nowy URL avatara:', USERS[CFG.user.uid].avatar || '');
        if (newAvatar !== null) {
          USERS[CFG.user.uid].avatar = newAvatar;
          CFG.users = USERS; // make sure the global change is stored
          persist();
          showUser();
        }
      });

      $('#closeModalBtn').onclick = () => {
        $('#newUserModal').classList.add('hidden');
      };

      $('#newUserForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const login = $('#newLogin').value;
        const password = $('#newPassword').value;
        const name = $('#newName').value;

        if (!/^(SoG[0-9]{4}|LK[0-9]{2}|[0-9]{2}|[0-9]{4})$/.test(login)) {
          alert('Format loginu jest nieprawidłowy. Użyj formatu SoGxxxx, LKxx, xx lub xxxx.');
          return;
        }

        if (USERS[login]) {
          alert('Użytkownik o takim loginie już istnieje.');
          return;
        }

        USERS[login] = { name: name, avatar: '', password: password || undefined };
        CFG.users = USERS;
        logLogin(login);
        CFG.user.uid = login;
        persist();

        $('#newUserModal').classList.add('hidden');
        $('#newUserForm').reset();

        showUser(); // update header immediately
        showUserDetailsModal(); // Show details modal for new user
      });
    }

    // --- init buttons
    function initNotesPlans(){
      const addNoteAction = async () => {
        const v=$('#noteInput').value.trim(); if(!v) return;
        let status='FINAL';
        if(isAdmin()){
          const code=prompt('Podaj kod (0..1000) aby opublikować do „chat”. Błędny -> DRAFT:','');
          const n = parseInt(code,10);
          if(!(n>=0 && n<=1000) || n!==ADMIN_PASS){
            status='DRAFT';
          } else {
            status='FINAL';
            chatPush(v);
          }
        }
        NOTES.push({id:Date.now()+Math.random(), ts:Date.now(), user:CFG.user.uid, userName:CFG.user.name, text:v, status});
        $('#noteInput').value=''; await saveNotes(); renderNotes();
      };

      $('#addNote').onclick = addNoteAction;
      $('#noteInput').addEventListener('keyup', (e) => {
          if (e.key === 'Enter') {
              addNoteAction();
          }
      });

      $('#addPlan').onclick=async()=>{
        const v=$('#planInput').value.trim(); if(!v) return;
        PLANS.push({id:Date.now()+Math.random(), ts:Date.now(), user:CFG.user.uid, userName:CFG.user.name, text:v});
        $('#planInput').value=''; await savePlans(); renderPlans();
      };

      $('#refreshNP').onclick=async()=>{ await loadNotes(); await loadPlans(); };

      loadNotes();
      loadPlans();

      setInterval(() => {
        loadNotes();
        loadPlans();
      }, 30000);
    }

    // --- machines render
    function initMachines(){ const box=$('#machines'); box.innerHTML=''; (CFG.machines||[]).forEach(m=> new Machine(box,m, CFG.orders||{})); }

    function initThemeSwitcher() {
      const themeButtons = $$('#themeSwitcher button');
      const body = document.body;

      function applyTheme(theme) {
        body.dataset.theme = theme;
        CFG.theme = theme;
        persist();
      }

      // Apply saved theme on load
      if (CFG.theme) {
        applyTheme(CFG.theme);
      }

      themeButtons.forEach(button => {
        button.addEventListener('click', () => {
          const theme = button.dataset.theme;
          applyTheme(theme);
        });
      });
    }

    function getTerminalId() {
        let terminal = localStorage.getItem('KN007_TERMINAL');
        if (!terminal) {
            const terminalName = 'Terminal' + String(Math.floor(Math.random() * 900) + 100).padStart(3, '0');
            const terminalKey = Math.random().toString(36).substring(2, 7); // e.g., 't12er'
            terminal = `${terminalName} (${terminalKey})`;
            localStorage.setItem('KN007_TERMINAL', terminal);
        }
        return terminal;
    }

    function logLogin(uid) {
        const user = USERS[uid];
        if (!user) return;

        const history = JSON.parse(localStorage.getItem('KN007_LOGINS') || '[]');
        const now = new Date();
        const terminalId = getTerminalId();
        const role = getUserRole(uid);

        const logEntry = {
            ts: now.toISOString(),
            user: `${uid} (${user.name || 'N/A'})`,
            terminal: terminalId,
            accountType: role ? role.name : 'Użytkownik'
        };

        history.unshift(logEntry); // Add to the beginning
        if (history.length > 100) { // Keep history to 100 entries
            history.pop();
        }
        localStorage.setItem('KN007_LOGINS', JSON.stringify(history));
    }

    function renderLoginHistory() {
        if (!isAdmin()) return;

        const list = $('#loginHistoryList');
        if (!list) return;

        const history = JSON.parse(localStorage.getItem('KN007_LOGINS') || '[]');
        if (history.length === 0) {
            list.innerHTML = '<p class="opacity-70">Brak historii logowań.</p>';
            return;
        }

        list.innerHTML = '';
        history.forEach(entry => {
            const d = new Date(entry.ts);
            const date = d.toLocaleDateString('pl-PL');
            const time = d.toLocaleTimeString('pl-PL');
            const logHtml = `<div class="row !items-center"><div class="txt text-sm">Użytkownik <strong>${entry.user}</strong> zalogował się dnia ${date} o godz. ${time} z <strong>${entry.terminal}</strong> na konto <strong>${entry.accountType}</strong>.</div></div>`;
            list.insertAdjacentHTML('beforeend', logHtml);
        });
    }

    function renderAdminPanel() {
      const footer = $('#adminFooter');
      if (isAdmin()) {
        footer.style.display = 'block';
        renderLoginHistory();
      } else {
        footer.style.display = 'none';
      }
    }

    function setLanguage(lang) {
        if (!TRANSLATIONS[lang]) return;
        document.documentElement.lang = lang;
        document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
        if (lang === 'ar') { document.body.style.fontSize = '17px'; }
        else { document.body.style.fontSize = '15px'; }

        $$('[data-translate-key]').forEach(el => {
            const key = el.dataset.translateKey;
            const translation = TRANSLATIONS[lang][key];
            if (translation) {
                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    el.placeholder = translation;
                } else {
                    // Sanitize to prevent HTML injection if keys are ever dynamic
                    const safeContent = document.createTextNode(translation);
                    // Handle elements with children (like the title H1)
                    const icon = el.querySelector('span');
                    el.innerHTML = ''; // Clear existing content
                    if(icon) el.appendChild(icon);
                    el.appendChild(safeContent);
                }
            }
        });
        CFG.language = lang;
        persist();

        $$('#langSwitcher button').forEach(btn => {
            btn.classList.toggle('primary', btn.dataset.lang === lang);
        });
    }

    function initLangSwitcher() {
        const langButtons = $$('#langSwitcher button');
        langButtons.forEach(button => {
            button.addEventListener('click', () => setLanguage(button.dataset.lang));
        });
        setLanguage(CFG.language || 'pl');
    }

    function initCustomTimeModal() {
        const modal = $('#customTimeModal');
        const form = $('#customTimeForm');
        const input = $('#customTimeInput');
        const closeBtn = $('#closeTimeModalBtn');

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (activePruefung) {
                activePruefung.setTime(input.value);
            }
            modal.classList.add('hidden');
            activePruefung = null;
            return false;
        });
        closeBtn.onclick = () => {
            modal.classList.add('hidden');
            activePruefung = null;
        };
    }

    const PickerManager = (() => {
        const picker = $('#colorPicker');
        let activeMachine = null;

        const close = () => {
            if (picker) picker.classList.add('hidden');
            activeMachine = null;
        };

        const open = (machine, e) => {
            activeMachine = machine;
            picker.style.left = e.pageX + 'px';
            picker.style.top = e.pageY + 'px';
            picker.classList.remove('hidden');
        };

        if(picker) {
            $$('button', picker).forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (activeMachine) {
                        activeMachine.setColor(button.dataset.color);
                    }
                    close();
                });
            });

            document.addEventListener('click', (e) => {
                if (activeMachine && !picker.contains(e.target)) {
                    close();
                }
            });
        }

        return { open };
    })();

    // Clean up expired snoozes on load
    try {
        const snoozed = JSON.parse(localStorage.getItem('KN007_SNOOZED') || '{}');
        const now = Date.now();
        for (const id in snoozed) {
            if (snoozed[id] < now) {
                delete snoozed[id];
            }
        }
        localStorage.setItem('KN007_SNOOZED', JSON.stringify(snoozed));
    } catch(e) { console.error("Failed to clean snoozed notifications", e); }


    const activeNotifications = {};
    function showUrgentNotification(id, message, level) {
        const snoozed = JSON.parse(localStorage.getItem('KN007_SNOOZED') || '{}');
        if (snoozed[id] && snoozed[id] > Date.now()) {
            return; // It's snoozed, do not show
        }
        if (activeNotifications[id]) return; // Already visible

        const container = $('#urgent-notifications');
        const newClass = level === 'danger' ? 'bg-red-800/90' : 'bg-orange-500/90';

        const el = document.createElement('div');
        el.id = `notification-${id}`;
        el.className = `alert ${newClass} flex items-center justify-between w-full`;
        el.innerHTML = `<div class="flex-grow cursor-pointer"><strong>PILNE:</strong> ${message}</div>
                        <div class="flex items-center gap-2 pl-4 border-l border-white/30">
                            <label for="next-ready-${id}" class="text-xs">Następny gotowy?</label>
                            <input type="checkbox" id="next-ready-${id}" class="next-ready-checkbox h-5 w-5" data-machine-code="${id}">
                        </div>`;

        el.querySelector('.flex-grow').onclick = () => hideUrgentNotification(id);

        const checkbox = el.querySelector('.next-ready-checkbox');
        const order = CFG.orders[id] || {};
        checkbox.checked = !!order.nextReady;
        checkbox.addEventListener('change', (e) => {
            const machineCode = e.target.dataset.machineCode;
            const isChecked = e.target.checked;
            if (!CFG.orders[machineCode]) CFG.orders[machineCode] = genOrder();
            CFG.orders[machineCode].nextReady = isChecked;
            persist();
            setStatus(`Zapisano status gotowości dla ${machineCode}`);
        });

        container.appendChild(el);
        activeNotifications[id] = el;
    }
    function hideUrgentNotification(id) {
        if (activeNotifications[id]) {
            activeNotifications[id].remove();
            delete activeNotifications[id];
        }
        const snoozed = JSON.parse(localStorage.getItem('KN007_SNOOZED') || '{}');
        snoozed[id] = Date.now() + 30 * 60 * 1000; // Snooze for 30 mins
        localStorage.setItem('KN007_SNOOZED', JSON.stringify(snoozed));
    }

    function showCustomConfirm(message, callback) {
        const modal = $('#customConfirmModal');
        const msgEl = $('#customConfirmMessage');
        const okBtn = $('#customConfirmOk');
        const cancelBtn = $('#customConfirmCancel');

        msgEl.textContent = message;
        modal.classList.remove('hidden');

        const newOkBtn = okBtn.cloneNode(true);
        okBtn.parentNode.replaceChild(newOkBtn, okBtn);

        const newCancelBtn = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

        const close = (result) => {
            modal.classList.add('hidden');
            callback(result);
        };

        newOkBtn.onclick = () => close(true);
        newCancelBtn.onclick = () => close(false);
    }

    function init(){ initThemeSwitcher(); initLangSwitcher(); initMachines(); initLogin(); initNotesPlans(); initUserDetailsModal(); renderAdminPanel(); initCustomTimeModal(); }
    init();
  </script>
</body>
</html>
