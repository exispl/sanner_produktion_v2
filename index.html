<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Kartonowy Napełniacz — v0.008r</title>
  <link rel="icon" href="favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --bg:#0e1117; --panel:#121826; --panel2:#0f1624; --text:#e5e7eb; --muted:#93a4b5; --accent:#22c55e; --line:#1f2937; --yellow:#fde047; }
    body[data-theme="light"] { --bg:#f3f4f6; --panel:#ffffff; --panel2:#f9fafb; --text:#111827; --muted:#6b7280; --accent:#16a34a; --line:#e5e7eb; }
    body[data-theme="light"] .btn{background:#e5e7eb;border-color:#d1d5db}
    body[data-theme="light"] .btn.primary{background:#16a34a;border-color:#15803d;color:white}
    body[data-theme="light"] .badge{background:#e5e7eb;color:#374151;border-color:#d1d5db}
    body[data-theme="light"] .progress, body[data-theme="light"] .pr-bar{background:#e5e7eb}
    body[data-theme="light"] .pr-head select.pr-select{background:var(--panel);border-color:var(--line);color:var(--text)}
    body[data-theme="light"] .pr-reset{background:var(--panel)}
    body[data-theme="light"] .stamp .chip{background:#e5e7eb;color:#374151;border-color:#d1d5db}
    body[data-theme="light"] .notes-list .row{border-bottom-color:#e5e7eb}
    body[data-theme="light"] .tag.draft{color:#92400e;border-color:#f59e0b;background:#fef3c7}
    body[data-theme="light"] .alert{background:#e5e7eb;color:#374151;border-color:#d1d5db}
    body[data-theme="blue"] { --bg:#0c1424; --panel:#101c36; --panel2:#0e1a31; --text:#e0e7ff; --muted:#a0b3d9; --accent:#60a5fa; --line:#1e294b; }
    body[data-theme="green"] { --bg:#052e16; --panel:#064e3b; --panel2:#043a2c; --text:#ecfdf5; --muted:#a7f3d0; --accent:#4ade80; --line:#022c22; }
    body{margin:0;background:linear-gradient(180deg,var(--panel),var(--panel2));color:var(--text);font:15px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif; transition: background .3s, color .3s;}
    .wrap{max-width:1200px;margin:auto;padding:12px 16px}
    .panel{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
    .head{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--line)}
    .body{padding:10px 14px}
    .badge{font-size:12px;color:#cbd5e1;background:#0b1220;padding:4px 8px;border-radius:999px;border:1px solid var(--line)}
    .btn{border:1px solid var(--line);background:#0b1220;color:var(--text);padding:6px 10px;border-radius:10px;cursor:pointer}
    .btn.primary{background:#0d3b2c;border-color:#184c39}
    .btn.ghost{background:transparent}
    .machines{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){.machines{grid-template-columns:1fr 1fr}}
    .machine .title{display:flex;align-items:center;gap:10px}
    .machine .title h2{margin:0;font-size:26px;letter-spacing:.3px}
    .meta{color:var(--muted);font-size:14px;margin:6px 0}
    .progress{margin-top:6px;height:18px;border:1px solid var(--line);border-radius:12px;background:#0b1220;position:relative;overflow:hidden}
    .progress .bar{position:absolute;inset:0 100% 0 0;background:linear-gradient(90deg,#22c55e,#86efac);transition:width .25s ease}
    .progress .label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:12px}
    .pruef{margin-top:10px}
    .pr-head{display:flex;gap:8px;align-items:center;margin-bottom:6px}
    .pr-bar{position:relative;height:38px;border:1px solid var(--line);border-radius:14px;background:#0b1220;overflow:hidden}
    .pr-fill{position:absolute;left:0;top:0;bottom:0;width:0%;background:linear-gradient(90deg,#22c55e,#84cc16);transition:width .5s linear}
    .pr-label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:700;letter-spacing:.3px; font-variant-numeric: tabular-nums;}
    .pr-reset{position:absolute;right:10px;top:50%;transform:translateY(-50%);border:1px solid var(--line);background:var(--panel2);border-radius:8px;padding:4px 8px;cursor:pointer; opacity: 0.7;}
    .pr-reset:hover{opacity:1}
    .notes-list .row{display:flex;gap:10px;align-items:flex-start;border-bottom:1px dashed #263446;padding:8px 0}
    .stamp{display:inline-flex;gap:6px;align-items:center}
    .stamp .chip{background:#0b1220;border:1px solid #263446;border-radius:999px;padding:2px 6px}
    .stamp .small{font-size:12px;color:#9aa8b6}
    .stamp .digits{font-variant-numeric:tabular-nums;letter-spacing:.2px}
    .notes-list .txt{flex:1}
    .notes-list .act{display:flex;gap:6px}
    .tag{display:inline-block;margin-left:6px;font-size:12px;padding:2px 6px;border-radius:999px;border:1px solid #3b4760}
    .tag.draft{color:#eab308;border-color:#a16207;background:#2a2208}
    .role-badge{font-size:12px;padding:3px 8px;border-radius:999px;font-weight:600;border:1px solid transparent}
    .role-senior-dev{color:white;background-color:#3b82f6}
    .role-teamleiter{color:white;background-color:#ec4899}
    .role-einrichter{color:white;background-color:#f97316}
    .role-admin{color:white;background-color:#60a5fa}
    .role-leiharbeiter{color:white;background-color:#9ca3af}
    .role-sanner-mitarbeiter{color:white;background-color:#22c55e}
    .role-user{color:white;background-color:#9ca3af}
    .user-info-popup{position:absolute;top:100%;left:0;z-index:10;width:280px;padding-top:8px;display:none;}
    .loginbar:hover .user-info-popup{display:block;}
    .user-info-popup .panel{border-width:2px;}
    .user-info-popup-grid{display:grid;grid-template-columns:100px 1fr;gap:12px;align-items:center;}
    .user-info-popup img{width:100px;height:100px;border-radius:12px;object-fit:cover;}
    #urgent-notifications .alert{color:white; border-color:transparent;}
    .alerts{display:flex;flex-wrap:wrap;gap:8px}
    .alert{display:flex;gap:8px;align-items:center;border:1px solid #2e3b53;border-radius:10px;padding:6px 10px;background:#0b1220}
    .carton-grid-container { animation: fadeIn .5s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .carton-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
    .carton-box {
        border: 1px solid var(--line); border-radius: 12px; padding: 10px; text-align: center;
        cursor: pointer; background: var(--panel2); transition: background .2s, transform .2s, box-shadow .2s;
        position: relative; overflow: hidden; min-height: 70px; display: flex; flex-direction: column;
        align-items: center; justify-content: center;
    }
    .carton-box:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,.2); }
    .carton-box .timer { font-size: 20px; font-weight: 600; font-variant-numeric: tabular-nums; }
    .carton-box .status { font-size: 11px; text-transform: uppercase; letter-spacing: .5px; margin-top: 4px; color: var(--muted); }
    .carton-box.active { background: linear-gradient(135deg, #15803d, #22c55e); color: white; border-color: #14532d; }
    .carton-box.active .status { color: white; opacity: .8; }
    .carton-box.waiting { background: linear-gradient(135deg, #a16207, #facc15); color: #422006; border-color: #78350f; }
    .carton-box.waiting .status { color: #422006; opacity: .8; }
    .carton-box.blinking { animation: blink 1s infinite; }
    @keyframes blink { 50% { background: var(--panel); color: var(--text); } }
    .carton-box.waiting.blinking { animation: blink-waiting 1s infinite; }
    @keyframes blink-waiting { 50% { background: #452a0d; color: #facc15; } }
    .ve-nummer-display { cursor: pointer; }
    .ve-nummer-display:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div id="urgent-notifications" class="fixed top-0 left-1/2 -translate-x-1/2 z-30 p-4 space-y-2 w-full max-w-2xl"></div>
  <header class="wrap">
    <div class="panel">
      <div class="head">
        <div class="flex items-center gap-4">
          <img src="https://www.sanner-group.com/typo3conf/ext/sanner_site/Resources/Public/Icons/Sanner-Icons/Sanner-Logo-Claim.svg" alt="Sanner Logo" class="h-10">
          <div class="loginbar flex items-center gap-3 relative">
            <img id="userAvatar" src="https://placehold.co/40" alt="Avatar" class="w-8 h-8 rounded-full cursor-pointer">
            <div class="flex flex-col items-start">
              <div>
                <strong id="loginName">Kamil Kowalczyk</strong>
                <small id="loginId" class="opacity-70">(SoG1917)</small>
              </div>
              <span id="loginRole" class="role-badge" style="display: none;"></span>
            </div>
            <button id="switchUserBtn" class="btn ghost text-xl p-1">👤</button>

            <div class="user-info-popup">
            <div class="panel">
              <div class="body user-info-popup-grid">
                <img id="popupUserAvatar" src="https://placehold.co/184" alt="User Avatar">
                <div>
                  <h3 id="popupUserName" class="font-bold text-lg">Imię Nazwisko</h3>
                  <p id="popupUserRole" class="text-sm"></p>
                  <p class="text-xs mt-2">Ostatnio zalogowany: <span id="popupLastLogin">teraz</span></p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="flex items-center gap-4">
            <div id="langSwitcher" class="flex gap-1">
              <button class="btn ghost text-xs" data-lang="pl">PL</button>
              <button class="btn ghost text-xs" data-lang="en">EN</button>
              <button class="btn ghost text-xs" data-lang="tr">TR</button>
              <button class="btn ghost text-xs" data-lang="de">DE</button>
              <button class="btn ghost text-xs" data-lang="ar">AR</button>
            </div>
            <div id="themeSwitcher" class="flex items-center gap-2">
              <button class="w-4 h-4 rounded-full border-2 border-white/20" style="background-color: #0e1117" data-theme="dark" title="Dark Theme"></button>
              <button class="w-4 h-4 rounded-full border-2 border-black/20" style="background-color: #f3f4f6" data-theme="light" title="Light Theme"></button>
              <button class="w-4 h-4 rounded-full border-2 border-white/20" style="background-color: #0c1424" data-theme="blue" title="Blue Theme"></button>
              <button class="w-4 h-4 rounded-full border-2 border-white/20" style="background-color: #052e16" data-theme="green" title="Green Theme"></button>
            </div>
            <div class="badge">v0.008r</div>
        </div>
      </div>
      <div class="body">
        <h1 class="m-0" data-translate-key="appTitle">🏭 Kartonowy Napełniacz</h1>
        <div id="statusLine" class="opacity-80 mt-1" data-translate-key="statusReady"></div>
        <div id="chatStream" class="alerts mt-2"></div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section id="machines" class="machines"></section>

    <div id="newUserModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4">
      <div class="panel w-full max-w-md">
        <div class="head">
          <h2 class="m-0" data-translate-key="createUserTitle">Tworzenie nowego użytkownika</h2>
          <button id="closeModalBtn" class="btn ghost">✖</button>
        </div>
        <div class="body">
          <form id="newUserForm" class="flex flex-col gap-4">
            <input type="text" id="newLogin" name="login" class="btn" data-translate-key="placeholderLogin" placeholder="Login (np. SoGxxxx, LK12, 1234)" required pattern="^(SoG[0-9]{4}|LK[0-9]{2}|[0-9]{2}|[0-9]{4})$">
            <input type="password" id="newPassword" name="password" class="btn" data-translate-key="placeholderPassword" placeholder="Hasło (opcjonalne)">
            <input type="text" id="newName" name="name" class="btn" data-translate-key="placeholderName" placeholder="Imię i nazwisko" required>
            <button type="submit" class="btn primary" data-translate-key="createUserBtn">Stwórz użytkownika</button>
          </form>
        </div>
      </div>
    </div>

    <section class="panel mt-3">
      <div class="head"><h2 class="m-0" data-translate-key="notesTitle">💬 CHAT</h2></div>
      <div class="body">
        <div class="flex gap-2 flex-wrap">
          <input id="noteInput" class="btn" style="flex:1" data-translate-key="placeholderNote" placeholder="Wpisz wiadomość...">
          <button id="addNote" class="btn primary" data-translate-key="addNoteBtn">Wyślij</button>
        </div>
        <div id="notesList" class="notes-list mt-2"></div>
      </div>
    </section>

    <section class="panel mt-3">
      <div class="head"><h2 class="m-0" data-translate-key="plansTitle">📌 Dalsze plany</h2></div>
      <div class="body">
        <div class="flex gap-2 flex-wrap">
          <input id="planInput" class="btn" style="flex:1" data-translate-key="placeholderPlan" placeholder="Nowy pomysł / zadanie…">
          <button id="addPlan" class="btn" data-translate-key="addPlanBtn">+ Dodaj plan</button>
          <button id="refreshNP" class="btn ghost" data-translate-key="refreshBtn">↻ Odśwież z MySQL</button>
        </div>
        <div id="plansList" class="notes-list mt-2"></div>
      </div>
    </section>
  </main>

  <div id="userDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-40">
    <div class="panel w-full max-w-md">
      <div class="head">
        <h2 class="m-0">Uzupełnij swoje dane</h2>
      </div>
      <div class="body">
        <form id="userDetailsForm" class="flex flex-col gap-4">
          <p>To jest Twoje pierwsze logowanie. Prosimy o uzupełnienie danych. Pola są opcjonalne.</p>
          <input type="text" id="detailsName" name="name" class="btn" placeholder="Imię i nazwisko">
          <input type="text" id="detailsDob" name="dob" class="btn" placeholder="Data urodzenia (DD.MM.RRRR)">
          <select id="detailsLang" name="lang" class="btn">
            <option value="pl">Polski</option>
            <option value="en">English</option>
            <option value="tr">Türkçe</option>
            <option value="de">Deutsch</option>
            <option value="ar">العربية</option>
          </select>
          <button type="submit" class="btn primary">Zapisz i kontynuuj</button>
        </form>
      </div>
    </div>
  </div>

  <div id="colorPicker" class="hidden absolute panel p-2 z-20">
    <div class="grid grid-cols-4 gap-2">
      <button class="w-6 h-6 rounded-full" style="background-color: #ef4444;" data-color="#ef4444"></button>
      <button class="w-6 h-6 rounded-full" style="background-color: #f97316;" data-color="#f97316"></button>
      <button class="w-6 h-6 rounded-full" style="background-color: #eab308;" data-color="#eab308"></button>
      <button class="w-6 h-6 rounded-full" style="background-color: #84cc16;" data-color="#84cc16"></button>
      <button class="w-6 h-6 rounded-full" style="background-color: #22c55e;" data-color="#22c55e"></button>
      <button class="w-6 h-6 rounded-full" style="background-color: #14b8a6;" data-color="#14b8a6"></button>
      <button class="w-6 h-6 rounded-full" style="background-color: #3b82f6;" data-color="#3b82f6"></button>
      <button class="w-6 h-6 rounded-full" style="background-color: #a855f7;" data-color="#a855f7"></button>
      <button class="w-6 h-6 rounded-full" style="background-color: #ec4899;" data-color="#ec4899"></button>
      <button class="w-6 h-6 rounded-full bg-white border" data-color="#ffffff"></button>
      <button class="w-6 h-6 rounded-full bg-slate-400" data-color="#94a3b8"></button>
      <button class="w-6 h-6 rounded-full bg-black border" data-color="#000000"></button>
    </div>
  </div>

  <div id="customTimeModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-20">
    <div class="panel w-full max-w-xs">
      <div class="head">
        <h2 class="m-0">Ustaw czas</h2>
        <button id="closeTimeModalBtn" class="btn ghost">✖</button>
      </div>
      <div class="body">
        <form id="customTimeForm" class="flex flex-col gap-4">
          <input type="number" id="customTimeInput" name="minutes" class="btn text-center text-lg" placeholder="Minuty" required>
          <button type="submit" class="btn primary">Ustaw</button>
        </form>
      </div>
    </div>
  </div>

  <div id="userSelectionModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-40">
    <div class="panel w-full max-w-sm">
      <div class="head">
        <h2 class="m-0" data-translate-key="userSelectionTitle">Wybierz użytkownika</h2>
        <button id="closeUserSelectionModalBtn" class="btn ghost">✖</button>
      </div>
      <div class="body">
        <ul id="userSelectionList" class="space-y-2 max-h-96 overflow-y-auto">
          <!-- User list will be populated here -->
        </ul>
        <hr class="border-white/10 my-4">
        <button id="createNewUserBtn" class="btn w-full" data-translate-key="createNewUserBtn">+ Stwórz nowego użytkownika</button>
      </div>
    </div>
  </div>

  <template id="tpl-user-list-item">
    <li class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/10 cursor-pointer user-select-item">
      <img src="https://placehold.co/40" alt="Avatar" class="w-10 h-10 rounded-full">
      <div class="flex-grow">
        <strong class="user-name"></strong>
        <div class="text-sm opacity-70 user-id"></div>
      </div>
      <span class="lock-icon text-lg"></span>
    </li>
  </template>

  <footer class="wrap" id="adminFooter" style="display: none;">
    <div class="panel mt-3">
      <div class="head">
        <h2 class="m-0">🔧 Panel Admina</h2>
      </div>
      <div class="body">
        <p>Tutaj znajdą się opcje administracyjne, takie jak zarządzanie użytkownikami i ich uprawnieniami.</p>
        <div id="loginHistory" class="mt-4">
            <h3 class="font-bold border-b border-white/10 pb-1">Historia logowań</h3>
            <div id="loginHistoryList" class="notes-list mt-2 max-h-60 overflow-y-auto"></div>
        </div>
      </div>
    </div>
  </footer>

  <template id="tpl-machine">
    <article class="panel machine">
      <div class="head">
        <div class="title"><span></span><h2 class="code"></h2></div>
        <div class="flex items-center gap-2">
            <span class="ve-nummer-display text-sm opacity-70" title="Kliknij lewym, aby skopiować. Kliknij prawym, aby edytować"></span>
            <button class="btn ghost settings-toggle">⚙️</button>
        </div>
      </div>
      <div class="body">
        <div class="meta text-sm space-y-2">
            <div class="border border-white/10 rounded-lg p-2">
                <div class="flex justify-between items-center">
                    <div class="flex gap-2 items-center">
                        <span data-translate-key="auftrag">Auftrag:</span>
                        <strong class="auf-val font-mono">—</strong>
                    </div>
                     <div class="flex gap-2 items-center">
                        <span data-translate-key="nextAuftrag">Następny:</span>
                        <span class="nextauf-val font-mono">—</span>
                    </div>
                </div>
            </div>
             <div class="flex gap-2 items-center px-2">
                <span data-translate-key="model">Model:</span>
                <strong class="mdl-val">—</strong>
                <span class="w-4 h-4 rounded-full bg-white/50 border border-white/20 model-color-dot cursor-pointer" title="Zmień kolor"></span>
            </div>
            <div class="border border-white/10 rounded-lg p-2 text-center">
                <span data-translate-key="period">Okres:</span>
                <span class="period-val">—</span>
            </div>
        </div>

        <div class="progress-container">
            <div class="progress mt-3"><div class="bar"></div><div class="label">0%</div></div>
            <div class="flex justify-between items-center mt-2 text-sm">
                <div data-translate-key="timeToComplete">Do ukończenia:</div>
                <div class="font-bold text-lg completion-time">--:--</div>
                <div class="completion-warning text-red-500 font-bold text-xl hidden">!</div>
            </div>
        </div>

        <div class="carton-grid-container" style="display:none;">
            <div class="carton-grid">
                <div class="carton-box" data-id="1"><div class="timer">00:00</div><div class="status"></div></div>
                <div class="carton-box" data-id="2"><div class="timer">00:00</div><div class="status"></div></div>
                <div class="carton-box" data-id="3"><div class="timer">00:00</div><div class="status"></div></div>
                <div class="carton-box" data-id="4"><div class="timer">00:00</div><div class="status"></div></div>
            </div>
            <div class="text-xs text-center opacity-60 mt-1" data-translate-key="cartonInstructions">Klik: zakończ/zacznij, 2-klik: reset.</div>
        </div>

        <div class="pruef">
          <div class="pr-head">
            <span data-translate-key="pruefungTime" class="whitespace-nowrap">🧪 Prüfung:</span>
            <div class="pr-buttons flex gap-1">
              <button class="btn ghost text-xs" data-time="3600">1H</button>
              <button class="btn ghost text-xs" data-time="7200">2H</button>
              <button class="btn ghost text-xs" data-time="10800">3H</button>
              <button class="btn ghost text-xs" data-time="custom" data-translate-key="customTime">Własny</button>
            </div>
          </div>
          <div class="pr-bar">
            <div class="pr-fill"></div><div class="pr-label">00:00:00</div><div class="pr-reset" title="Resetuj timer">⟲</div>
          </div>
        </div>

        <div class="machine-settings hidden mt-4 space-y-2">
          <h4 class="font-bold border-b border-white/10 pb-1" data-translate-key="settingsTitle">Ustawienia</h4>
          <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm items-center">
            <label data-translate-key="modelLabel">Model:</label>
            <input type="text" class="setting-input btn text-sm" data-source="order" data-key="model">
            <label data-translate-key="durationMinLabel">Czas (min):</label>
            <input type="number" class="setting-input btn text-sm w-24" data-source="machine" data-key="durationMin">
            <label data-translate-key="fourCartonSystemLabel">System 4 kartonów:</label>
            <input type="checkbox" class="setting-checkbox" data-source="machine" data-key="fourCartonSystem">
          </div>
           <small class="text-xs opacity-60" data-translate-key="saveHint">Wciśnij ENTER w polu tekstowym, aby zapisać.</small>
        </div>
      </div>
    </article>
  </template>

  <script>
    const NOTES_KEY='KN007_NOTES';
    const PLANS_KEY='KN007_PLANS';
    const ADMIN_PASS = 4753;

    const TRANSLATIONS = {
      pl: { appTitle: '🏭 Kartonowy Napełniacz', createUserTitle: 'Tworzenie nowego użytkownika', placeholderLogin: 'Login (np. SoGxxxx lub LK12)', placeholderPassword: 'Hasło', placeholderName: 'Imię i nazwisko', createUserBtn: 'Stwórz użytkownika', notesTitle: '💬 CHAT', placeholderNote: 'Wpisz wiadomość...', addNoteBtn: 'Wyślij', plansTitle: '📌 Dalsze plany', placeholderPlan: 'Nowy pomysł / zadanie…', addPlanBtn: '+ Dodaj plan', refreshBtn: '↻ Odśwież z MySQL', auftrag: 'Auftrag:', nextAuftrag: 'Następny:', model: 'Model:', period: 'Okres:', timeToComplete: 'Do ukończenia:', cartonInstructions: 'Klik: zakończ/zacznij, 2-klik: reset.', pruefungTime: '🧪 Prüfung:', customTime: 'Własny', settingsTitle: 'Ustawienia', modelLabel: 'Model:', durationMinLabel: 'Czas (min):', fourCartonSystemLabel: 'System 4 kartonów:', saveHint: 'Wciśnij ENTER w polu tekstowym, aby zapisać.' },
      en: { appTitle: '🏭 Cardboard Filler', createUserTitle: 'Create new user', placeholderLogin: 'Login (e.g. SoGxxxx or LK12)', placeholderPassword: 'Password', placeholderName: 'First and last name', createUserBtn: 'Create User', notesTitle: '💬 CHAT', placeholderNote: 'Enter a message...', addNoteBtn: 'Send', plansTitle: '📌 Future plans', placeholderPlan: 'New idea / task…', addPlanBtn: '+ Add plan', refreshBtn: '↻ Refresh from MySQL', auftrag: 'Order:', nextAuftrag: 'Next:', model: 'Model:', period: 'Period:', timeToComplete: 'Time to complete:', cartonInstructions: 'Click: end/start, 2-click: reset.', pruefungTime: '🧪 Test:', customTime: 'Custom', settingsTitle: 'Settings', modelLabel: 'Model:', durationMinLabel: 'Time (min):', fourCartonSystemLabel: '4-carton system:', saveHint: 'Press ENTER in a text field to save.' },
      de: { appTitle: '🏭 Karton-Füller', createUserTitle: 'Neuen Benutzer erstellen', placeholderLogin: 'Login (z.B. SoGxxxx oder LK12)', placeholderPassword: 'Passwort', placeholderName: 'Vor- und Nachname', createUserBtn: 'Benutzer erstellen', notesTitle: '💬 CHAT', placeholderNote: 'Nachricht eingeben…', addNoteBtn: 'Senden', plansTitle: '📌 Weitere Pläne', placeholderPlan: 'Neue Idee / Aufgabe…', addPlanBtn: '+ Plan hinzufügen', refreshBtn: '↻ Von MySQL aktualisieren', auftrag: 'Auftrag:', nextAuftrag: 'Nächster:', model: 'Modell:', period: 'Zeitraum:', timeToComplete: 'Bis zur Fertigstellung:', cartonInstructions: 'Klick: beenden/starten, 2-Klick: zurücksetzen.', pruefungTime: '🧪 Prüfung:', customTime: 'Eigene', settingsTitle: 'Einstellungen', modelLabel: 'Modell:', durationMinLabel: 'Zeit (min):', fourCartonSystemLabel: '4-Karton-System:', saveHint: 'Drücken Sie ENTER in einem Textfeld, um zu speichern.' },
      tr: { appTitle: '🏭 Karton Doldurucu', createUserTitle: 'Yeni kullanıcı oluştur', placeholderLogin: 'Giriş (ör. SoGxxxx veya LK12)', placeholderPassword: 'Şifre', placeholderName: 'Ad ve soyad', createUserBtn: 'Kullanıcı Oluştur', notesTitle: '💬 SOHBET', placeholderNote: 'Bir mesaj girin...', addNoteBtn: 'Gönder', plansTitle: '📌 Gelecek planları', placeholderPlan: 'Yeni fikir / görev…', addPlanBtn: '+ Plan ekle', refreshBtn: '↻ MySQL\'den yenile', auftrag: 'Sipariş:', nextAuftrag: 'Sonraki:', model: 'Model:', period: 'Dönem:', timeToComplete: 'Tamamlanma süresi:', cartonInstructions: 'Tıkla: bitir/başlat, 2-tıkla: sıfırla.', pruefungTime: '🧪 Test:', customTime: 'Özel', settingsTitle: 'Ayarlar', modelLabel: 'Model:', durationMinLabel: 'Süre (dk):', fourCartonSystemLabel: '4-karton sistemi:', saveHint: 'Kaydetmek için bir metin alanında ENTER\'a basın.' },
      ar: { appTitle: '🏭 حشو الكرتون', createUserTitle: 'إنشاء مستخدم جديد', placeholderLogin: 'تسجيل الدخول (على سبيل المثال SoGxxxx أو LK12)', placeholderPassword: 'كلمة المرور', placeholderName: 'الاسم الأول والأخير', createUserBtn: 'إنشاء مستخدم', notesTitle: '💬 دردشة', placeholderNote: 'أدخل رسالة…', addNoteBtn: 'إرسال', plansTitle: '📌 خطط مستقبلية', placeholderPlan: 'فكرة / مهمة جديدة…', addPlanBtn: '+ إضافة خطة', refreshBtn: '↻ تحديث من MySQL', auftrag: 'طلب:', nextAuftrag: 'التالي:', model: 'نموذج:', period: 'فترة:', timeToComplete: 'الوقت المتبقي:', cartonInstructions: 'انقر: إنهاء/بدء، نقرتان: إعادة تعيين.', pruefungTime: '🧪 فحص:', customTime: 'مخصص', settingsTitle: 'الإعدادات', modelLabel: 'نموذج:', durationMinLabel: 'الوقت (دقيقة):', fourCartonSystemLabel: 'نظام 4 كرتونات:', saveHint: 'اضغط على ENTER في حقل النص للحفظ.' }
    };

    let USERS = {
      'SoG1917': { name: 'Kamil Kowalczyk', avatar: '', password: String(ADMIN_PASS) },
      'SoG2025': { name: 'John Locke', avatar: '' },
      'SoG1':    { name: 'Michael Scott', avatar: '' },
      'SoG1899': { name: 'James Corden', avatar: '' },
      'SoP1':    { name: 'Piotr Nowak', avatar: '' },
      'SoG2020': { name: 'User 2020', avatar: '' },
    };

    const DEFAULTS={
      version: 2,
      user: { uid: 'SoG1917' },
      users: USERS,
      machines:[
        { code:'MA820061', durationMin:25, fourCartonSystem: true },
        { code:'MA820062', durationMin:22, fourCartonSystem: true },
        { code:'MA820063', durationMin:25, fourCartonSystem: false },
        { code:'MA820064', durationMin:25, fourCartonSystem: false },
      ],
      orders:{},
    };
    let CFG=JSON.parse(localStorage.getItem('KN007_CFG')||'null')||DEFAULTS;
    if (CFG.users) { USERS = CFG.users; } else { CFG.users = USERS; }

    const $=(s,r=document)=>r.querySelector(s), $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const isAdmin=()=> CFG.user?.uid==='SoG1917';
    function persist(){ localStorage.setItem('KN007_CFG', JSON.stringify(CFG)); }
    function setStatus(t, duration = 3000){ const el = $('#statusLine'); el.textContent='Status: '+t; setTimeout(() => el.textContent = '', duration); }

    async function saveShared(key,json){ try{ const res=await fetch('storage.php?a=set&key='+encodeURIComponent(key),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(json)}); const j=await res.json(); return !!j.ok; }catch(e){ console.error(e); return false; } }
    async function loadShared(key){ try{ const res=await fetch('storage.php?a=get&key='+encodeURIComponent(key)); const j=await res.json(); return j.v?JSON.parse(j.v):null; }catch(e){ console.error(e); return null; } }

    let activePruefung = null;
    class Pruefung {
        constructor(root, machineData) {
            this.root = root;
            this.machineData = machineData;
            this.fill = $('.pr-fill', root);
            this.label = $('.pr-label', root);
            this.buttons = $$('.pr-buttons button', root);
            this.reset = $('.pr-reset', root);
            this.bar = $('.pr-bar', root);
            this.total = this.machineData.pruefTotal || 3600;
            this.start = this.machineData.pruefStart || 0;
            if (this.start === 0) { this.start = Date.now(); this.machineData.pruefStart = this.start; persist(); }
            this.bind(); this.tick();
        }
        bind() {
            this.buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const v = btn.dataset.time;
                    if (v === 'custom') { activePruefung = this; $('#customTimeModal').classList.remove('hidden'); $('#customTimeInput').focus(); }
                    else { this.setTime(parseInt(v, 10) / 60); }
                });
            });
            this.reset.addEventListener('click', (e) => { e.stopPropagation(); if (confirm('Czy na pewno chcesz zresetować timer Prüfung?')) { this.start = Date.now(); this.machineData.pruefStart = this.start; persist(); } });
            this.bar.addEventListener('contextmenu', (e) => { e.preventDefault(); activePruefung = this; $('#customTimeModal').classList.remove('hidden'); $('#customTimeInput').focus(); });
        }
        setTime(minutes) {
            this.total = Math.max(60, (parseInt(minutes, 10) || 0) * 60);
            this.start = Date.now();
            this.machineData.pruefTotal = this.total;
            this.machineData.pruefStart = this.start;
            persist();
            this.buttons.forEach(b => b.classList.remove('primary'));
        }
        tick() {
            const el = Math.min(this.total, Math.floor((Date.now() - this.start) / 1000));
            const left = this.total - el;
            if (left <= 0) {
                this.fill.style.width = '100%'; this.label.textContent = 'ZAKOŃCZONO';
                if (!this.root.classList.contains('pruef-ended')) { this.root.classList.add('pruef-ended'); this.fill.style.background = '#ef4444'; }
            } else {
                this.root.classList.remove('pruef-ended'); this.fill.style.background = '';
                const pct = this.total > 0 ? Math.floor(el / this.total * 100) : 0;
                this.fill.style.width = pct + '%';
                const hh = String(Math.floor(left / 3600)).padStart(2, '0');
                const mm = String(Math.floor((left % 3600) / 60)).padStart(2, '0');
                const ss = String(left % 60).padStart(2, '0');
                this.label.textContent = `${hh}:${mm}:${ss}`;
            }
            const currentTotalHours = this.total / 3600;
            this.buttons.forEach(b => { if (b.dataset.time) { b.classList.toggle('primary', parseInt(b.dataset.time, 10) / 3600 === currentTotalHours); } });
            requestAnimationFrame(() => this.tick());
        }
    }

    let activeMachineForColor = null;
    class Machine {
        constructor(container, data, orders) {
            this.root = $('#tpl-machine').content.firstElementChild.cloneNode(true);
            this.container = container;
            this.data = data;
            this.orders = orders;
            this.code = data.code;
            this.lastClickTime = 0;
            this.data.durationMin = this.data.durationMin || 25;
            this.titleIconEl = $('.title span', this.root);
            $('.code', this.root).textContent = this.code;
            this.veNummerEl = $('.ve-nummer-display', this.root);
            this.dot = $('.model-color-dot', this.root);
            this.settingsToggle = $('.settings-toggle', this.root);
            this.settingsPanel = $('.machine-settings', this.root);
            this.settingsInputs = $$('.setting-input', this.settingsPanel);
            this.settingsCheckboxes = $$('.setting-checkbox', this.settingsPanel);
            this.progressContainer = $('.progress-container', this.root);
            this.cartonGridContainer = $('.carton-grid-container', this.root);
            this.bar = $('.bar', this.root);
            this.label = $('.label', this.root);
            this.completionTimeEl = $('.completion-time', this.root);
            this.completionWarningEl = $('.completion-warning', this.root);
            this.cartonBoxes = $$('.carton-box', this.root);
            this.pr = new Pruefung($('.pruef', this.root), this.data);
            this.bindEvents();
            this.render();
            this.tick();
            this.container.appendChild(this.root);
        }
        bindEvents() {
            this.dot.addEventListener('contextmenu', (e) => { e.preventDefault(); activeMachineForColor = this; const picker = $('#colorPicker'); picker.style.left = e.pageX + 'px'; picker.style.top = e.pageY + 'px'; picker.classList.remove('hidden'); });
            this.settingsToggle.addEventListener('click', () => this.settingsPanel.classList.toggle('hidden'));
            this.settingsInputs.forEach(input => { input.addEventListener('keyup', (e) => { if (e.key === 'Enter') this.saveSetting(input); }); });
            this.settingsCheckboxes.forEach(checkbox => { checkbox.addEventListener('change', () => this.saveSetting(checkbox)); });
            this.cartonBoxes.forEach(box => {
                box.addEventListener('click', () => {
                    const clickTime = Date.now();
                    const cartonId = parseInt(box.dataset.id, 10);
                    if (clickTime - this.lastClickTime < 300) { this.handleCartonDoubleClick(cartonId); }
                    else { this.handleCartonSingleClick(cartonId); }
                    this.lastClickTime = clickTime;
                });
            });
            this.veNummerEl.addEventListener('click', (e) => { e.preventDefault(); navigator.clipboard.writeText(this.data.veNummer || '').then(() => { setStatus(`Skopiowano VE numer: ${this.data.veNummer}`); }); });
            this.veNummerEl.addEventListener('contextmenu', (e) => { e.preventDefault(); const newVe = prompt('Wprowadź nowy numer VE:', this.data.veNummer || ''); if (newVe !== null) { this.data.veNummer = newVe.trim(); this.render(); persist(); } });
        }
        saveSetting(element) {
            const key = element.dataset.key;
            const source = element.dataset.source;
            let value;
            if (element.type === 'checkbox') { value = element.checked; }
            else if (element.type === 'number') { value = parseFloat(element.value) || 0; }
            else { value = element.value; }
            if (source === 'machine') {
                this.data[key] = value;
                if (key === 'durationMin') { this.data.cartons.forEach(c => { if (c.status === 'idle') c.duration = value * 60; }); }
            } else if (source === 'order') {
                if (!this.orders[this.code]) this.orders[this.code] = genOrder();
                this.orders[this.code][key] = value;
            }
            if (element.type !== 'checkbox') element.blur();
            this.render(); persist(); setStatus(`Zapisano ${key} dla ${this.code}`);
        }
        handleCartonSingleClick(cartonId) {
            const carton = this.data.cartons.find(c => c.id === cartonId); if (!carton) return;
            if (carton.status === 'active') { carton.status = 'done'; const waitingCarton = this.data.cartons.find(c => c.status === 'waiting'); if (waitingCarton) { waitingCarton.status = 'active'; waitingCarton.startTime = Date.now(); } }
            else if (carton.status === 'idle') { const isAnyActive = this.data.cartons.some(c => c.status === 'active'); const isAnyWaiting = this.data.cartons.some(c => c.status === 'waiting'); if (isAnyActive) { if (!isAnyWaiting) { carton.status = 'waiting'; } } else { carton.status = 'active'; carton.startTime = Date.now(); } }
            this.render(); persist();
        }
        handleCartonDoubleClick(cartonId) {
            const carton = this.data.cartons.find(c => c.id === cartonId); if (!carton) return;
            carton.status = 'idle'; carton.startTime = 0; carton.duration = (this.data.durationMin || 25) * 60;
            const wasActive = this.root.querySelector(`[data-id="${cartonId}"]`).classList.contains('active');
            if (wasActive) { const waitingCarton = this.data.cartons.find(c => c.status === 'waiting'); if (waitingCarton) { waitingCarton.status = 'active'; waitingCarton.startTime = Date.now(); } }
            this.render(); persist();
        }
        render() {
            const order = this.orders[this.code] || {};
            $('.auf-val', this.root).textContent = order.auftrag || '—';
            $('.mdl-val', this.root).textContent = order.model || '—';
            $('.period-val', this.root).textContent = order.period || '—';
            $('.nextauf-val', this.root).textContent = order.next || '—';
            this.veNummerEl.textContent = this.data.veNummer ? `VE: ${this.data.veNummer}` : 'VE: ---';
            this.dot.style.backgroundColor = this.data.color || '#94a3b8';
            this.titleIconEl.textContent = this.data.fourCartonSystem ? '📦' : '🤖';
            this.settingsInputs.forEach(input => { const key = input.dataset.key; const source = input.dataset.source; if (source === 'machine') input.value = this.data[key] || ''; else if (source === 'order') input.value = order[key] || ''; });
            this.settingsCheckboxes.forEach(checkbox => { const key = checkbox.dataset.key; const source = checkbox.dataset.source; if (source === 'machine') checkbox.checked = !!this.data[key]; });
            if (this.data.fourCartonSystem) { this.progressContainer.style.display = 'none'; this.cartonGridContainer.style.display = 'block'; this.renderCartonGrid(); }
            else { this.progressContainer.style.display = 'block'; this.cartonGridContainer.style.display = 'none'; this.renderProgressBar(); }
        }
        renderCartonGrid() {
            const allDone = this.data.cartons.every(c => c.status === 'done');
            if (allDone) { this.data.cartons.forEach(c => { c.status = 'idle'; c.startTime = 0; }); }
            this.cartonBoxes.forEach(box => {
                const cartonId = parseInt(box.dataset.id, 10);
                const carton = this.data.cartons.find(c => c.id === cartonId); if (!carton) return;
                const timerEl = $('.timer', box); const statusEl = $('.status', box);
                box.classList.remove('active', 'waiting', 'blinking');
                let timeLeft = 0, elapsed = 0;
                switch (carton.status) {
                    case 'active': box.classList.add('active'); statusEl.textContent = 'W TRAKCIE'; elapsed = (Date.now() - carton.startTime) / 1000; timeLeft = Math.max(0, carton.duration - elapsed); if (timeLeft < 300) box.classList.add('blinking'); break;
                    case 'waiting': box.classList.add('waiting'); statusEl.textContent = 'OCZEKUJE'; timeLeft = carton.duration; break;
                    case 'done': statusEl.textContent = 'UKOŃCZONO'; timerEl.textContent = '✓'; return;
                    default: statusEl.textContent = 'GOTOWY'; timeLeft = carton.duration; break;
                }
                const minutes = String(Math.floor(timeLeft / 60)).padStart(2, '0');
                const seconds = String(Math.floor(timeLeft % 60)).padStart(2, '0');
                timerEl.textContent = `${minutes}:${seconds}`;
            });
        }
        renderProgressBar() {
            if (!this.data.completionTimestamp) { this.data.completionTimestamp = Date.now() + (this.data.durationMin * 60 * 1000); }
            const now = Date.now(); const startTime = this.data.completionTimestamp - (this.data.durationMin * 60 * 1000);
            const totalDuration = this.data.completionTimestamp - startTime; const elapsed = now - startTime;
            const p = Math.min(1, elapsed / totalDuration);
            this.bar.style.width = (p * 100) + '%'; this.label.textContent = Math.floor(p * 100) + '%';
            const timeLeft = Math.max(0, Math.floor((this.data.completionTimestamp - now) / 1000));
            const hours = Math.floor(timeLeft / 3600); const minutes = Math.floor((timeLeft % 3600) / 60);
            this.completionTimeEl.textContent = `${String(hours)}h ${String(minutes).padStart(2, '0')}m`;
        }
        tick() {
            if (this.data.fourCartonSystem) { this.renderCartonGrid(); } else { this.renderProgressBar(); }
            requestAnimationFrame(() => this.tick());
        }
        setColor(color) { this.data.color = color; this.render(); persist(); }
    }

    function genOrder(){ const rnd=String(Math.floor(Math.random()*10000)).padStart(4,'0'); const s=new Date(); const e=new Date(); e.setDate(s.getDate()+5); const F=d=>`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`; return { auftrag:'1012'+rnd, model:'DASG-1 (201044)', period:`od ${F(s)} do ${F(e)}`, next:'' }; }
    function renderMachines(){ const box=$('#machines'); box.innerHTML=''; (CFG.machines||[]).forEach(m=> new Machine(box,m, CFG.orders||{})); }

    function makeStamp(ts,user,smaller=false){ const d=new Date(ts); const dd=String(d.getDate()).padStart(2,'0'), mm=String(d.getMonth()+1).padStart(2,'0'), yyyy=d.getFullYear(); const hh=String(d.getHours()).padStart(2,'0'), min=String(d.getMinutes()).padStart(2,'0'); const small=smaller?' small':''; return `<span class="stamp"><span class="chip small digits${small}">[${dd}/${mm}/${yyyy}]</span><span class="chip small digits${small}">[${hh}:${min}]</span><span class="chip small">${user.uid} (${user.name})</span></span>`; }
    function chatPush(text){ const el=document.createElement('div'); el.className='alert'; el.innerHTML=`<span>💬 ${text}</span> <button class="btn ghost">✖</button>`; $('.btn',el).onclick=()=>el.remove(); $('#chatStream').prepend(el); }

    let NOTES=[], PLANS=[];
    function renderNotes(){
      const list=$('#notesList'); list.innerHTML='';
      NOTES.forEach(n=>{ const row=document.createElement('div'); row.className='row'; const tag = n.status==='DRAFT' ? '<span class="tag draft">DRAFT</span>' : ''; row.innerHTML=`<div class="meta">${makeStamp(n.ts, {uid:n.user,name:n.userName})} ${tag}</div><div class="txt">${n.text}</div><div class="act"></div>`; const act=$('.act',row); if(isAdmin()){ const bE=document.createElement('button'); bE.className='btn'; bE.textContent='✏️'; bE.title='Edytuj'; const bR=document.createElement('button'); bR.className='btn'; bR.textContent='↩️'; bR.title='Odpowiedz'; const bD=document.createElement('button'); bD.className='btn'; bD.textContent='🗑️'; bD.title='Usuń'; bE.onclick=async()=>{ const v=prompt('Edytuj notatkę', n.text); if(v!=null){ n.text=v; await saveNotes(); renderNotes(); } }; bR.onclick=async()=>{ const v=prompt('Odpowiedź', ''); if(v){ NOTES.push({id:Date.now()+Math.random(), ts:Date.now(), user:CFG.user.uid, userName:CFG.user.name, text:`↪ ${v} (odpowiedź na #${n.id})`, status:'FINAL'}); await saveNotes(); renderNotes(); } }; bD.onclick=async()=>{ if(confirm('Usunąć notatkę?')){ NOTES = NOTES.filter(x=>x.id!==n.id); await saveNotes(); renderNotes(); } }; act.append(bE,bR,bD); } list.appendChild(row); });
    }
    function renderPlans(){ const list=$('#plansList'); list.innerHTML=''; PLANS.forEach(p=>{ const row=document.createElement('div'); row.className='row'; row.innerHTML=`<div class="meta">${makeStamp(p.ts, {uid:p.user,name:p.userName}, true)}</div><div class="txt">${p.text}</div>`; list.appendChild(row); }); }
    async function saveNotes(){ await saveShared(NOTES_KEY, NOTES); }
    async function loadNotes(){ const db=await loadShared(NOTES_KEY); if(db){ NOTES=db; } renderNotes(); }
    async function savePlans(){ await saveShared(PLANS_KEY, PLANS); }
    async function loadPlans(){ const db=await loadShared(PLANS_KEY); if(db){ PLANS=db; } renderPlans(); }

    function getUserRole(uid) {
        if (!uid) return null;
        const ROLES = { 'SoG1917': { name: 'Senior Developer', className: 'role-senior-dev' }, 'SoG2025': { name: 'TeamLeiter', className: 'role-teamleiter' }, 'SoG2020': { name: 'Einrichter', className: 'role-einrichter' }, };
        if (ROLES[uid]) return ROLES[uid];
        if (uid.startsWith('SoG')) return { name: 'Administrator', className: 'role-admin' };
        if (uid.startsWith('LK')) return { name: 'Leiharbeiter', className: 'role-leiharbeiter' };
        if (uid.startsWith('SoP')) return { name: 'Administrator', className: 'role-admin' };
        return { name: 'Użytkownik', className: 'role-user' };
    }
    function showUser(){
      const uid = CFG.user?.uid; const user = USERS[uid] || { name: 'Nieznany', avatar: '' };
      $('#loginName').textContent = user.name; $('#loginId').textContent = uid || '';
      const avatarSrc = user.avatar || 'https://placehold.co/40/0e1117/ffffff?text=' + (user.name?.[0] || '?');
      $('#userAvatar').src = avatarSrc;
      const role = getUserRole(uid); const roleEl = $('#loginRole');
      if (role) { roleEl.textContent = role.name; roleEl.className = 'role-badge ' + role.className; roleEl.style.display = 'inline-block'; } else { roleEl.style.display = 'none'; }
      $('#popupUserAvatar').src = user.avatar || 'https://placehold.co/184/0e1117/ffffff?text=' + (user.name?.[0] || '?');
      $('#popupUserName').textContent = user.name; $('#popupUserRole').textContent = role ? role.name : 'Użytkownik';
    }
    function showUserDetailsModal() { const currentUser = USERS[CFG.user.uid]; if (currentUser) { $('#detailsName').value = currentUser.name || ''; $('#detailsLang').value = CFG.language || 'pl'; } $('#userDetailsModal').classList.remove('hidden'); }
    function initUserDetailsModal() { $('#userDetailsForm').addEventListener('submit', (e) => { e.preventDefault(); const user = USERS[CFG.user.uid]; if (user) { user.name = $('#detailsName').value; user.dob = $('#detailsDob').value; user.details_filled = true; const selectedLang = $('#detailsLang').value; setLanguage(selectedLang); CFG.users = USERS; persist(); showUser(); $('#userDetailsModal').classList.add('hidden'); window.location.reload(); } }); }
    function initLogin() {
        showUser();
        const currentUser = USERS[CFG.user.uid];
        if (currentUser && !currentUser.details_filled) {
            showUserDetailsModal();
        }

        const switchUserBtn = $('#switchUserBtn');
        const userSelectionModal = $('#userSelectionModal');
        if (!switchUserBtn || !userSelectionModal) return;

        const closeUserSelectionModalBtn = $('#closeUserSelectionModalBtn');
        const userSelectionList = $('#userSelectionList');
        const createNewUserBtn = $('#createNewUserBtn');
        const userItemTpl = $('#tpl-user-list-item');

        function renderUserSelectionList() {
            userSelectionList.innerHTML = '';
            for (const uid in USERS) {
                const user = USERS[uid];
                const item = userItemTpl.content.firstElementChild.cloneNode(true);

                item.dataset.uid = uid;
                $('.user-name', item).textContent = user.name;
                $('.user-id', item).textContent = uid;
                $('img', item).src = user.avatar || 'https://placehold.co/40/0e1117/ffffff?text=' + (user.name?.[0] || '?');
                if (user.password) {
                    $('.lock-icon', item).textContent = '🔒';
                }

                item.addEventListener('click', () => handleUserSelection(uid));

                userSelectionList.appendChild(item);
            }
        }

        function handleUserSelection(uid) {
            if (uid === CFG.user.uid) {
                userSelectionModal.classList.add('hidden');
                return;
            }

            const userToLogin = USERS[uid];
            if (userToLogin && userToLogin.password) {
                const pass = prompt(`Wprowadź hasło dla ${uid}:`);
                if (pass !== userToLogin.password) {
                    alert('Błędne hasło!');
                    return;
                }
            }

            logLogin(uid);
            CFG.user.uid = uid;
            persist();

            userSelectionModal.classList.add('hidden');

            const newCurrentUser = USERS[uid];
            if (newCurrentUser && !newCurrentUser.details_filled) {
                showUser();
                showUserDetailsModal();
            } else {
                window.location.reload();
            }
        }

        switchUserBtn.addEventListener('click', () => {
            renderUserSelectionList();
            userSelectionModal.classList.remove('hidden');
        });

        closeUserSelectionModalBtn.addEventListener('click', () => {
            userSelectionModal.classList.add('hidden');
        });

        createNewUserBtn.addEventListener('click', () => {
            userSelectionModal.classList.add('hidden');
            $('#newUserModal').classList.remove('hidden');
        });

        $('#userAvatar').addEventListener('click', () => {
            const newAvatar = prompt('Podaj nowy URL avatara:', USERS[CFG.user.uid].avatar || '');
            if (newAvatar !== null) {
                USERS[CFG.user.uid].avatar = newAvatar;
                CFG.users = USERS;
                persist();
                showUser();
            }
        });

        $('#closeModalBtn').onclick = () => {
            $('#newUserModal').classList.add('hidden');
        };

        $('#newUserForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const login = $('#newLogin').value;
            const password = $('#newPassword').value;
            const name = $('#newName').value;
            if (!/^(SoG[0-9]{4}|LK[0-9]{2}|[0-9]{2}|[0-9]{4})$/.test(login)) {
                alert('Format loginu jest nieprawidłowy. Użyj formatu SoGxxxx, LKxx, xx lub xxxx.');
                return;
            }
            if (USERS[login]) {
                alert('Użytkownik o takim loginie już istnieje.');
                return;
            }
            USERS[login] = { name: name, avatar: '', password: password || undefined };
            CFG.users = USERS;
            logLogin(login);
            CFG.user.uid = login;
            persist();
            $('#newUserModal').classList.add('hidden');
            $('#newUserForm').reset();
            showUser();
            showUserDetailsModal();
        });
    }

    function initNotesPlans(){
      const noteInput = $('#noteInput');
      const addNoteBtn = $('#addNote');
      const currentUser = USERS[CFG.user.uid] || {};

      const sendNote = async () => {
        const v = noteInput.value.trim();
        if (!v) return;

        let status = 'FINAL';
        if (isAdmin()) {
          const code = prompt('Podaj kod (0..1000) aby opublikować do „chat”. Błędny -> DRAFT:', '');
          const n = parseInt(code, 10);
          if (!(n >= 0 && n <= 1000) || n !== ADMIN_PASS) {
            status = 'DRAFT';
          } else {
            status = 'FINAL';
            chatPush(v);
          }
        }

        NOTES.push({ id: Date.now() + Math.random(), ts: Date.now(), user: CFG.user.uid, userName: currentUser.name, text: v, status });
        noteInput.value = '';
        await saveNotes();
        renderNotes();
      };

      addNoteBtn.onclick = sendNote;

      noteInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendNote();
        }
      });

      $('#addPlan').onclick=async()=>{
        const v=$('#planInput').value.trim(); if(!v) return;
        PLANS.push({id:Date.now()+Math.random(), ts:Date.now(), user:CFG.user.uid, userName: currentUser.name, text:v});
        $('#planInput').value=''; await savePlans(); renderPlans();
      };
      $('#refreshNP').onclick=async()=>{ await loadNotes(); await loadPlans(); };
      loadNotes(); loadPlans();
    }

    function initThemeSwitcher() { const body = document.body; function applyTheme(theme) { body.dataset.theme = theme; CFG.theme = theme; persist(); } if (CFG.theme) { applyTheme(CFG.theme); } $$('#themeSwitcher button').forEach(button => { button.addEventListener('click', () => { applyTheme(button.dataset.theme); }); }); }
    function getTerminalId() { let terminal = localStorage.getItem('KN007_TERMINAL'); if (!terminal) { const terminalName = 'Terminal' + String(Math.floor(Math.random() * 900) + 100).padStart(3, '0'); const terminalKey = Math.random().toString(36).substring(2, 7); terminal = `${terminalName} (${terminalKey})`; localStorage.setItem('KN007_TERMINAL', terminal); } return terminal; }
    function logLogin(uid) { const user = USERS[uid]; if (!user) return; const history = JSON.parse(localStorage.getItem('KN007_LOGINS') || '[]'); const now = new Date(); const terminalId = getTerminalId(); const role = getUserRole(uid); const logEntry = { ts: now.toISOString(), user: `${uid} (${user.name || 'N/A'})`, terminal: terminalId, accountType: role ? role.name : 'Użytkownik' }; history.unshift(logEntry); if (history.length > 100) { history.pop(); } localStorage.setItem('KN007_LOGINS', JSON.stringify(history)); }
    function renderLoginHistory() { if (!isAdmin()) return; const list = $('#loginHistoryList'); if (!list) return; const history = JSON.parse(localStorage.getItem('KN007_LOGINS') || '[]'); if (history.length === 0) { list.innerHTML = '<p class="opacity-70">Brak historii logowań.</p>'; return; } list.innerHTML = ''; history.forEach(entry => { const d = new Date(entry.ts); const date = d.toLocaleDateString('pl-PL'); const time = d.toLocaleTimeString('pl-PL'); const logHtml = `<div class="row !items-center"><div class="txt text-sm">Użytkownik <strong>${entry.user}</strong> zalogował się dnia ${date} o godz. ${time} z <strong>${entry.terminal}</strong> na konto <strong>${entry.accountType}</strong>.</div></div>`; list.insertAdjacentHTML('beforeend', logHtml); }); }
    function renderAdminPanel() { const footer = $('#adminFooter'); if (isAdmin()) { footer.style.display = 'block'; renderLoginHistory(); } else { footer.style.display = 'none'; } }
    function setLanguage(lang) { if (!TRANSLATIONS[lang]) return; document.documentElement.lang = lang; document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr'; if (lang === 'ar') { document.body.style.fontSize = '17px'; } else { document.body.style.fontSize = '15px'; } $$('[data-translate-key]').forEach(el => { const key = el.dataset.translateKey; const translation = TRANSLATIONS[lang][key]; if (translation) { if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') { el.placeholder = translation; } else { const safeContent = document.createTextNode(translation); const icon = el.querySelector('span'); el.innerHTML = ''; if(icon) el.appendChild(icon); el.appendChild(safeContent); } } }); CFG.language = lang; persist(); $$('#langSwitcher button').forEach(btn => { btn.classList.toggle('primary', btn.dataset.lang === lang); }); }
    function initLangSwitcher() { $$('#langSwitcher button').forEach(button => { button.addEventListener('click', () => setLanguage(button.dataset.lang)); }); setLanguage(CFG.language || 'pl'); }
    function initCustomTimeModal() { const modal = $('#customTimeModal'); const form = $('#customTimeForm'); const input = $('#customTimeInput'); const closeBtn = $('#closeTimeModalBtn'); form.addEventListener('submit', (e) => { e.preventDefault(); if (activePruefung) { activePruefung.setTime(input.value); } modal.classList.add('hidden'); activePruefung = null; }); closeBtn.onclick = () => { modal.classList.add('hidden'); activePruefung = null; }; }
    function initColorPicker() { const picker = $('#colorPicker'); $$('button', picker).forEach(button => { button.addEventListener('click', (e) => { e.stopPropagation(); const color = button.dataset.color; if (activeMachineForColor) { activeMachineForColor.setColor(color); } picker.classList.add('hidden'); activeMachineForColor = null; }); }); document.addEventListener('click', (e) => { if (!picker.contains(e.target) && activeMachineForColor) { picker.classList.add('hidden'); activeMachineForColor = null; } }); }

    function migrateCfg() {
        let changed = false;
        if (!CFG.version || CFG.version < 2) {
            (CFG.machines || []).forEach(m => {
                if (m.fourCartonSystem === undefined) { m.fourCartonSystem = false; changed = true; }
                if (!m.cartons || m.cartons.length !== 4) {
                    m.cartons = [ { id: 1, status: 'idle', startTime: 0, duration: (m.durationMin || 25) * 60 }, { id: 2, status: 'idle', startTime: 0, duration: (m.durationMin || 25) * 60 }, { id: 3, status: 'idle', startTime: 0, duration: (m.durationMin || 25) * 60 }, { id: 4, status: 'idle', startTime: 0, duration: (m.durationMin || 25) * 60 }, ];
                    changed = true;
                }
                if (m.pruef) { m.pruefTotal = m.pruef; delete m.pruef; changed = true; }
                if (!m.pruefStart) { m.pruefStart = 0; changed = true; }
            });
            CFG.version = 2;
            if (changed) persist();
            console.log('Migrated CFG to version 2');
        }
    }

    function init(){ migrateCfg(); initThemeSwitcher(); initLangSwitcher(); renderMachines(); initLogin(); initNotesPlans(); initUserDetailsModal(); renderAdminPanel(); initCustomTimeModal(); initColorPicker(); }
    init();
  </script>
</body>
</html>
